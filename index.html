<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Microhyper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
    .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.18); }
    .glow { box-shadow: 0 0 14px rgba(139, 92, 246, 0.35); }
    .btn-primary { transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.25); }
    .signal-long { background: linear-gradient(45deg, #22c55e, #16a34a); }
    .signal-short { background: linear-gradient(45deg, #ef4444, #dc2626); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #toast {
      transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
      transform: translateY(-100px);
      opacity: 0;
    }
    #toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Modal Styles */
    #api-key-modal, #ai-response-modal {
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
    }
    #api-key-modal.show, #ai-response-modal.show {
      opacity: 1;
    }
    
    /* Settings Modal */
    #settings-modal {
      transition: opacity 0.3s ease-in-out;
      opacity: 0;
    }
    #settings-modal.show {
      opacity: 1;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
  </style>
</head>
<body class="text-white text-sm md:text-base">
  <!-- API Key Modal -->
  <div id="api-key-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center hidden">
    <div class="glass p-6 rounded-2xl max-w-md w-full mx-4 shadow-2xl border border-violet-500/30">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-key text-violet-400"></i> Authentication Required
      </h2>
      <p class="text-sm opacity-70 mb-4">Please enter your API Access Token to continue.</p>
      <input type="password" id="api-key-input" placeholder="Enter API Key" class="w-full px-4 py-3 rounded-lg bg-black/40 border border-white/10 focus:border-violet-500 focus:outline-none mb-4 text-white" />
      
      <input type="text" id="cf-client-id" placeholder="CF Access Client ID" class="w-full px-4 py-3 rounded-lg bg-black/40 border border-white/10 focus:border-violet-500 focus:outline-none mb-4 text-white" />
      <input type="password" id="cf-client-secret" placeholder="CF Access Client Secret" class="w-full px-4 py-3 rounded-lg bg-black/40 border border-white/10 focus:border-violet-500 focus:outline-none mb-4 text-white" />
      
      <div class="mb-4">
        <label class="text-[10px] uppercase tracking-wide opacity-60 mb-1 block">API Endpoint (CORS Proxy if needed)</label>
        <input type="text" id="api-endpoint" placeholder="https://test.me" class="w-full px-4 py-3 rounded-lg bg-black/40 border border-white/10 focus:border-violet-500 focus:outline-none text-white text-xs" />
      </div>

      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="remember-me" class="w-4 h-4 rounded border-white/10 bg-black/40 accent-violet-600 focus:ring-violet-500">
        <label for="remember-me" class="text-xs opacity-70 cursor-pointer select-none">Remember me (Save to LocalStorage)</label>
      </div>

      <button onclick="saveApiKey()" class="w-full py-3 btn-primary rounded-xl font-bold bg-violet-600 hover:bg-violet-700">
        Connect
      </button>
    </div>
  </div>

  <!-- AI Response Modal -->
  <div id="ai-response-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center hidden" onclick="closeAiModal(event)">
    <div class="glass p-6 rounded-2xl max-w-md w-full mx-4 shadow-2xl border border-violet-500/30 relative" onclick="event.stopPropagation()">
      <button onclick="closeAiModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-brain text-violet-400"></i> AI Analysis
      </h2>
      <div id="ai-response-content" class="space-y-4">
        <!-- Content injected via JS -->
        <div class="animate-pulse flex space-x-4">
            <div class="flex-1 space-y-4 py-1">
                <div class="h-4 bg-white/10 rounded w-3/4"></div>
                <div class="space-y-2">
                    <div class="h-4 bg-white/10 rounded"></div>
                    <div class="h-4 bg-white/10 rounded w-5/6"></div>
                </div>
            </div>
        </div>
      </div>
      <div class="mt-6 flex gap-3">
        <button onclick="closeAiModal()" class="flex-1 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors">Close</button>
        <button onclick="executeTradeFromModal()" id="btn-modal-trade" class="flex-1 py-2 rounded-lg btn-primary font-bold bg-violet-600 hover:bg-violet-700 hidden">
            Execute Trade
        </button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center hidden" onclick="closeSettingsModal(event)">
    <div class="glass p-6 rounded-2xl max-w-sm w-full mx-4 shadow-2xl border border-violet-500/30 relative" onclick="event.stopPropagation()">
      <button onclick="closeSettingsModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
        <i class="fas fa-cog text-violet-400"></i> App Settings
      </h2>
      
      <div class="mb-6">
        <label class="block text-xs font-bold uppercase tracking-wide mb-2 opacity-70">AI Persona Prompts</label>
        <div class="space-y-2 max-h-[300px] overflow-y-auto pr-1" id="persona-options-container">
           <!-- Options injected via JS -->
           <div class="animate-pulse h-10 bg-white/10 rounded-lg"></div>
        </div>
        <p class="text-[10px] opacity-50 mt-2">Select the personality set used for AI analysis across the app.</p>
      </div>

      <button onclick="saveSettings()" id="btn-save-settings" class="w-full py-3 btn-primary rounded-xl font-bold bg-violet-600 hover:bg-violet-700">
        Save Changes
      </button>
    </div>
  </div>

  <!-- Pair Manager Modal -->
  <div id="pair-manager-modal" class="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center hidden" onclick="closePairManager(event)">
    <div class="glass p-6 rounded-2xl max-w-2xl w-full mx-4 shadow-2xl border border-violet-500/30 relative flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
      <button onclick="closePairManager()" class="absolute top-4 right-4 text-white/50 hover:text-white">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-list text-violet-400"></i> Pair Manager
      </h2>
      
      <div class="flex gap-2 mb-4">
        <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-3 text-white/30"></i>
            <input type="text" id="pair-search" placeholder="Search pairs (e.g. SOL, BTC)..." class="w-full pl-10 pr-4 py-2 rounded-lg bg-white/5 border border-white/10 focus:border-violet-500 focus:outline-none text-sm" oninput="filterPairTable()">
        </div>
        <button onclick="refreshPairData()" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10" title="Refresh Data">
            <i class="fas fa-sync-alt text-white/70"></i>
        </button>
      </div>

      <!-- Table Header -->
      <div class="grid grid-cols-12 gap-2 px-2 py-2 text-[10px] font-bold uppercase tracking-wider opacity-60 border-b border-white/10">
        <div class="col-span-3 cursor-pointer hover:text-white" onclick="sortPairs('name')">Pair <i class="fas fa-sort ml-1"></i></div>
        <div class="col-span-3 md:col-span-2 text-right cursor-pointer hover:text-white" onclick="sortPairs('price')">Price <i class="fas fa-sort ml-1"></i></div>
        <div class="col-span-3 md:col-span-2 text-right cursor-pointer hover:text-white" onclick="sortPairs('change')">24h % <i class="fas fa-sort ml-1"></i></div>
        <div class="hidden md:block md:col-span-3 text-right cursor-pointer hover:text-white" onclick="sortPairs('volume')">Vol (24h) <i class="fas fa-sort ml-1"></i></div>
        <div class="col-span-3 md:col-span-2 text-center">Action</div>
      </div>

      <!-- Table Body -->
      <div id="pair-table-body" class="overflow-y-auto flex-1 pr-1 space-y-1 mt-1">
         <div class="text-center py-8 opacity-50"><i class="fas fa-circle-notch spin"></i> Loading pairs...</div>
      </div>
      
      <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
          <span class="text-xs opacity-50" id="pair-count-label">0 pairs selected</span>
          <button onclick="closePairManager()" class="px-6 py-2 rounded-lg bg-violet-600 hover:bg-violet-700 font-bold text-sm">Done</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-5 right-5 z-50 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg hidden">
    <p id="toast-message"></p>
  </div>

  <div class="container mx-auto px-3 py-4 max-w-5xl">
    <!-- Status Dashboard -->
    <div id="status-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-center">
      <div id="status-current-price" class="glass rounded-lg p-3 md:p-4"></div>
      <div id="status-available-margin" class="glass rounded-lg p-3 md:p-4"></div>
      <div id="status-open-position" class="glass rounded-lg p-3 md:p-4"></div>
      <div id="status-open-orders" class="glass rounded-lg p-3 md:p-4"></div>
    </div>

    <div class="grid lg:grid-cols-2 gap-4">
      <!-- Manual Trade Panel -->
      <div class="lg:col-span-2">
        <div class="glass rounded-2xl p-4 md:p-6 glow">
          <div class="flex items-center justify-between mb-4 gap-4">
            <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
              <i class="fas fa-chart-line text-green-400"></i> Microhyper
            </h2>
            <div class="flex gap-2 text-xs md:text-sm">
              <button id="btn-close-position" class="px-3 py-1.5 rounded-lg bg-red-600/80 hover:bg-red-700 flex items-center gap-1" onclick="closePosition()">
                <i class="fas fa-door-open"></i><span>Close Position</span>
              </button>
              <button id="btn-cancel-orders" class="px-3 py-1.5 rounded-lg bg-amber-500/80 hover:bg-amber-600 flex items-center gap-1" onclick="cancelOpenOrders()">
                <i class="fas fa-ban"></i><span>Cancel Orders</span>
              </button>
            </div>
          </div>

          <!-- AI Control Center -->
          <div class="mb-4 p-2 rounded-xl bg-white/5 border border-white/10">
             <!-- Header: Status & Settings -->
             <div class="flex items-center justify-between mb-2">
                 <div class="flex items-center gap-2 overflow-hidden w-full">
                    <div id="bot-indicator" class="w-2.5 h-2.5 rounded-full bg-gray-500 transition-colors flex-shrink-0 mt-0.5"></div>
                    <div class="flex flex-col min-w-0 w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold uppercase tracking-wide whitespace-nowrap">AI</span>
                            <!-- Settings (Inline) -->
                            <button onclick="openSettingsModal()" class="w-5 h-5 flex items-center justify-center rounded hover:bg-white/20 transition-colors" title="Prompt Settings">
                                <i class="fas fa-cog text-[20px] text-white/70"></i>
                            </button>
                            <span id="persona-badge" class="text-[9px] font-bold uppercase tracking-wider bg-violet-500/20 px-1.5 py-0.5 rounded border border-violet-500/30 text-violet-200 truncate opacity-0 transition-opacity">--</span>
                            
                            <!-- Counter Trade Switch -->
                            <div class="flex items-center gap-1.5 ml-2 cursor-pointer group" onclick="toggleCounterTrade()" title="Counter Trade Mode (Invert AI Signals)">
                                <div id="counter-trade-switch" class="w-7 h-3.5 rounded-full bg-white/10 relative transition-colors border border-white/10">
                                    <div id="counter-trade-knob" class="absolute left-0.5 top-px w-2.5 h-2.5 rounded-full bg-white/40 transition-all"></div>
                                </div>
                                <span class="text-[9px] uppercase font-bold opacity-40 transition-colors" id="counter-trade-label">Norm</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-0.5 pr-1">
                             <div id="bot-status-text" class="text-[10px] opacity-50 whitespace-nowrap leading-none">System Idle</div>
                             <div id="market-changes" class="flex gap-2 text-[9px] font-mono opacity-70"></div>
                        </div>
                    </div>
                 </div>
             </div>

             <!-- AI Actions Grid -->
             <div class="grid grid-cols-3 gap-2">
                  <!-- Auto Bot -->
                 <button id="btn-bot-toggle" onclick="toggleBot()" class="flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 transition-all group relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-tr from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i class="fas fa-power-off text-green-400 text-sm group-hover:scale-110 transition-transform"></i>
                    <span class="text-s font-bold opacity-90">Auto</span>
                 </button>
                 <!-- Ask AI -->
                 <button id="btn-ask-ai" onclick="askAi()" class="flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 transition-all group">
                    <i class="fas fa-comment-dots text-violet-300 text-sm group-hover:scale-110 transition-transform"></i>
                    <span class="text-s font-bold opacity-90">Ask AI</span>
                 </button>

                 <!-- Trade AI (Single) -->
                 <button id="btn-ai" onclick="executeAITrade()" class="flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 transition-all group">
                    <i class="fas fa-robot text-blue-300 text-sm group-hover:scale-110 transition-transform"></i>
                    <span class="text-s font-bold opacity-90">1 Trade</span>
                 </button>


             </div>
          </div>

          <div class="grid grid-cols-12 gap-2 mb-4 items-end">
            <!-- Pair -->
            <div class="col-span-12">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">Pair</label>
              <div class="flex gap-2">
                  <select id="pair" class="w-full px-2 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm">
                    <!-- Options populated via JS -->
                  </select>
                  <button onclick="openPairManager()" class="px-3 py-2 rounded-lg bg-white/10 border border-white/15 hover:bg-white/20 transition-colors" title="Manage Pairs">
                      <i class="fas fa-sliders-h text-violet-300"></i>
                  </button>
              </div>
            </div>

            <!-- Leverage -->
            <div class="col-span-3">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">Lev</label>
              <input type="number" id="leverage" value="20" min="1" max="50" class="w-full px-2 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm text-center"/>
            </div>

            <!-- Position Size USD -->
            <div class="col-span-4">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">Margin ($)</label>
              <input type="number" step="1" id="size_usd" value="1" min="1" class="w-full px-2 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm"/>
            </div>

            <!-- Take Profit Price -->
            <div class="col-span-5">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">TP <span class="font-normal normal-case opacity-50">(Opt)</span></label>
              <div class="flex gap-1">
                <input type="number" step="0.01" id="tp_price" placeholder="Price" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm"/>
                <button id="btn-update-tp" onclick="updateTP()" class="px-2 rounded-lg bg-blue-600/80 hover:bg-blue-700 text-xs flex items-center justify-center" title="Update TP">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Mini Price Chart -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-1 text-xs opacity-75">
              <div class="flex items-center gap-2">
                <span class="flex items-center gap-1"><i class="fas fa-chart-bar text-violet-400"></i> Price Action</span>
                <div class="flex bg-white/10 rounded-lg p-0.5">
                  <button onclick="setChartInterval('1m')" id="btn-1m" class="px-2 py-0.5 rounded text-[10px] hover:bg-white/10 transition-colors">1m</button>
                  <button onclick="setChartInterval('3m')" id="btn-3m" class="px-2 py-0.5 rounded text-[10px] bg-violet-500/50 text-white font-bold">3m</button>
                </div>
              </div>
              <span id="mini-chart-label" class="text-[10px] uppercase tracking-wide"></span>
            </div>
            <div class="glass rounded-xl p-2 relative">
              <!-- Chart Overlay Chips -->
              <div id="chart-overlay" class="absolute top-2 left-2 flex flex-col gap-1 pointer-events-none hidden z-10">
                <div class="bg-black/60 backdrop-blur-md px-1.5 py-0.5 rounded text-[9px] border border-white/10 flex items-center justify-between gap-2 shadow-lg min-w-[60px]">
                   <span class="opacity-60 uppercase tracking-wider text-[8px] font-semibold">Liq</span>
                   <span id="overlay-liq" class="font-mono font-bold text-orange-400">--</span>
                </div>
                <div class="bg-black/60 backdrop-blur-md px-1.5 py-0.5 rounded text-[9px] border border-white/10 flex items-center justify-between gap-2 shadow-lg min-w-[60px]">
                   <span class="opacity-60 uppercase tracking-wider text-[8px] font-semibold">PnL</span>
                   <span id="overlay-pnl" class="font-mono font-bold">--</span>
                </div>
              </div>
              <canvas id="mini-chart" class="w-full" height="180"></canvas>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button id="btn-long" onclick="executeTrade('LONG')" class="py-3 btn-primary rounded-xl font-semibold text-base bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 flex items-center justify-center gap-2">
              <i class="fas fa-arrow-up"></i><span>Long</span>
            </button>
            <button id="btn-short" onclick="executeTrade('SHORT')" class="py-3 btn-primary rounded-xl font-semibold text-base bg-gradient-to-r from-red-600 to-rose-700 hover:from-red-700 hover:to-rose-800 flex items-center justify-center gap-2">
              <i class="fas fa-arrow-down"></i><span>Short</span>
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Trade History Section -->
    <div class="mt-6">
      <!-- Tabs Navigation -->
      <div class="flex items-center gap-6 mb-4 border-b border-white/10 overflow-x-auto">
        <button onclick="switchTab('trades')" id="tab-btn-trades" class="pb-2 border-b-2 border-violet-500 text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap">
            <i class="fas fa-history text-violet-400"></i> Hist. Trade
        </button>
        <button onclick="switchTab('ai-logs')" id="tab-btn-ai-logs" class="pb-2 border-b-2 border-transparent text-white/50 hover:text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap">
            <i class="fas fa-brain text-violet-400"></i> AI
        </button>
        <button onclick="switchTab('running-bots')" id="tab-btn-running-bots" class="pb-2 border-b-2 border-transparent text-white/50 hover:text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap">
            <i class="fas fa-robot text-violet-400"></i> Bots
        </button>
        <button onclick="switchTab('positions')" id="tab-btn-positions" class="pb-2 border-b-2 border-transparent text-white/50 hover:text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap">
            <i class="fas fa-list-alt text-violet-400"></i> Positions
        </button>
      </div>

      <!-- Tab Content: Trades -->
      <div id="tab-content-trades">
        <div class="flex flex-col gap-4 mb-4">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-4">
              <!-- Range Slider -->
              <div class="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/10 hover:bg-white/10 transition-colors group">
                  <i class="fas fa-clock text-[10px] opacity-50 group-hover:text-violet-400 transition-colors"></i>
                  <input type="range" id="history-range-slider" min="2" max="168" step="2" value="24" 
                         class="w-24 md:w-32 h-1 bg-white/20 rounded-lg appearance-none cursor-pointer accent-violet-500 hover:accent-violet-400 transition-all"
                         oninput="updateHistoryRange(this.value)">
                  <span id="history-range-label" class="text-[10px] font-mono font-bold w-8 text-right text-violet-300">24h</span>
              </div>
            </div>

            <div id="history-stats" class="flex flex-wrap gap-2 text-xs md:justify-end">
               <!-- Stats injected via JS -->
               <div class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 animate-pulse w-32 h-8"></div>
            </div>
          </div>
        </div>
        
        <!-- Desktop Header (Hidden on Mobile) -->
        <div class="hidden md:grid grid-cols-8 gap-4 px-4 py-2 text-[10px] font-bold opacity-50 uppercase tracking-wider border-b border-white/10 mb-1">
          <div class="col-span-2">Time</div>
          <div class="col-span-1">Side</div>
          <div class="col-span-1 text-right">Price</div>
          <div class="col-span-1 text-right">Size</div>
          <div class="col-span-1 text-right">Value</div>
          <div class="col-span-1 text-right">Fee</div>
          <div class="col-span-1 text-right">PnL</div>
        </div>

        <div id="trade-history-container" class="flex flex-col gap-3 md:gap-0 max-h-[400px] overflow-y-auto pr-1">
          <div class="glass rounded-xl p-4 text-center opacity-50">Loading history...</div>
        </div>
      </div>

      <!-- Tab Content: AI Logs -->
      <div id="tab-content-ai-logs" class="hidden">
        <div class="flex items-center justify-between gap-2 mb-4 overflow-x-auto pb-1 no-scrollbar">
            <div class="flex items-center gap-2 flex-shrink-0">
                <label class="text-[10px] font-bold uppercase tracking-wide opacity-70">Prompt:</label>
                <select id="ai-log-filter" onchange="filterAiLogs(this.value)" class="bg-white/10 border border-white/10 rounded px-2 py-1 text-xs focus:outline-none focus:border-violet-500">
                    <option value="All">All</option>
                </select>
            </div>
            <div class="flex gap-2 text-xs flex-shrink-0">
                <div class="px-2 py-1 rounded bg-green-500/10 border border-green-500/20 text-green-400 text-[10px] font-bold uppercase">
                    L: <span id="ai-log-longs">0</span>
                </div>
                <div class="px-2 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-400 text-[10px] font-bold uppercase">
                    S: <span id="ai-log-shorts">0</span>
                </div>
            </div>
        </div>
        <div id="ai-logs-container" class="flex flex-col gap-3 max-h-[600px] overflow-y-auto pr-1">
            <div class="glass rounded-xl p-6 text-center opacity-50">Loading AI logs...</div>
        </div>
      </div>

      <!-- Tab Content: Running Bots -->
      <div id="tab-content-running-bots" class="hidden">
        <div id="running-bots-stats" class="flex items-center gap-4 md:gap-6 overflow-x-auto pb-2 mb-4 border-b border-white/5 no-scrollbar whitespace-nowrap">
             <!-- Stats injected via JS -->
        </div>
        <div id="running-bots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto pr-1">
            <div class="glass rounded-xl p-6 text-center opacity-50 col-span-full">Loading bots...</div>
        </div>
      </div>

      <!-- Tab Content: Open Positions -->
      <div id="tab-content-positions" class="hidden">
        <div id="open-positions-container">
            <div class="p-6 text-center opacity-50">Loading positions...</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-6 opacity-60 text-xs md:text-sm">
      <p>Microhyper@2025 â€¢ <span id="clock"></span></p>
    </div>
  </div>

  <script>
    // Removed const API_BASE. Using dynamic getter.
    function getApiBase() {
      return localStorage.getItem('MICROHYPER_API_BASE') || sessionStorage.getItem('MICROHYPER_API_BASE') || "https://test.me";
    }
    
    // --- Auth Logic ---
    function getStoredKey() {
      return sessionStorage.getItem('MICROHYPER_API_KEY') || localStorage.getItem('MICROHYPER_API_KEY');
    }

    function getStoredCfCreds() {
      const id = sessionStorage.getItem('MICROHYPER_CF_ID') || localStorage.getItem('MICROHYPER_CF_ID');
      const secret = sessionStorage.getItem('MICROHYPER_CF_SECRET') || localStorage.getItem('MICROHYPER_CF_SECRET');
      return { id, secret };
    }

    function clearStoredKey() {
      sessionStorage.removeItem('MICROHYPER_API_KEY');
      localStorage.removeItem('MICROHYPER_API_KEY');
      sessionStorage.removeItem('MICROHYPER_CF_ID');
      localStorage.removeItem('MICROHYPER_CF_ID');
      sessionStorage.removeItem('MICROHYPER_CF_SECRET');
      localStorage.removeItem('MICROHYPER_CF_SECRET');
    }

    axios.interceptors.request.use(config => {
      const apiKey = getStoredKey();
      const { id, secret } = getStoredCfCreds();

      if (apiKey) {
        config.headers['X-API-Key'] = apiKey;
      }
      if (id && secret) {
        config.headers['CF-Access-Client-Id'] = id;
        config.headers['CF-Access-Client-Secret'] = secret;
      }
      return config;
    }, error => Promise.reject(error));

    axios.interceptors.response.use(response => response, error => {
      if (error.response && (error.response.status === 403 || error.response.status === 401)) {
        clearStoredKey();
        showApiKeyModal();
      }
      return Promise.reject(error);
    });

    function showApiKeyModal() {
      const modal = document.getElementById('api-key-modal');
      // Pre-fill endpoint
      document.getElementById('api-endpoint').value = getApiBase();
      
      modal.classList.remove('hidden');
      // Small delay to allow display change to render before opacity transition
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);
    }

    function saveApiKey() {
      const input = document.getElementById('api-key-input');
      const cfIdInput = document.getElementById('cf-client-id');
      const cfSecretInput = document.getElementById('cf-client-secret');
      const endpointInput = document.getElementById('api-endpoint');
      const rememberMe = document.getElementById('remember-me').checked;
      
      const key = input.value.trim();
      const cfId = cfIdInput.value.trim();
      const cfSecret = cfSecretInput.value.trim();
      const endpoint = endpointInput.value.trim() || "https://test.me";
      
      if (key) {
        if (rememberMe) {
          localStorage.setItem('MICROHYPER_API_KEY', key);
          localStorage.setItem('MICROHYPER_API_BASE', endpoint);
          if (cfId) localStorage.setItem('MICROHYPER_CF_ID', cfId);
          if (cfSecret) localStorage.setItem('MICROHYPER_CF_SECRET', cfSecret);
        } else {
          sessionStorage.setItem('MICROHYPER_API_KEY', key);
          sessionStorage.setItem('MICROHYPER_API_BASE', endpoint);
          if (cfId) sessionStorage.setItem('MICROHYPER_CF_ID', cfId);
          if (cfSecret) sessionStorage.setItem('MICROHYPER_CF_SECRET', cfSecret);
        }
        
        const modal = document.getElementById('api-key-modal');
        modal.classList.remove('show');
        // Wait for transition to finish before hiding
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 500);
        
        fetchStatus();
        fetchMiniChart();
        fetchHistory();
        fetchAiLogs();
        fetchSettings(); // Fetch settings on login
      } else {
        input.classList.add('border-red-500');
      }
    }
    // ------------------

    let selectedDirection = "LONG";
    let chartInterval = "3m"; // Default to 3m
    let lastFetchedTrades = [];
    let lastFetchedAiLogs = []; // New global
    let lastFetchedPositions = []; // Store positions for sorting
    let currentAiLogFilter = 'All'; // Persist filter selection
    let currentHistoryRange = 24;
    let currentTab = 'trades';
    let currentPosSort = { field: 'open_time', dir: 'desc' }; // Sort state for positions
    let lastAiSignal = null; // Store last AI signal for modal execution
    let counterTradeActive = false; // New state
    
    // Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    // Store persona preferences per pair locally
    let personaPreferences = {}; 

    // --- Pair Manager Logic ---
    let allPairsData = [];
    let activePairs = JSON.parse(localStorage.getItem('MICROHYPER_ACTIVE_PAIRS')) || ["SOL", "BTC", "ETH", "XRP", "HYPE", "ZEC", "PUMP", "BCH"];
    let currentSort = { field: 'volume', dir: 'desc' };

    function initPairs() {
        updatePairDropdown();
        // Fetch metadata in background to populate leverage info
        fetchPairsData().then(() => {
            updatePairDropdown();
        });
    }

    async function fetchPairsData() {
        try {
            const res = await axios.get(`${getApiBase()}/pairs`);
            allPairsData = res.data;
            return allPairsData;
        } catch (err) {
            console.error("Failed to fetch pairs metadata", err);
            return [];
        }
    }

    function updatePairDropdown() {
        const select = document.getElementById('pair');
        const currentVal = select.value;
        
        select.innerHTML = activePairs.map(p => {
            const meta = allPairsData.find(x => x.name === p);
            // Use a clean format for leverage
            const levInfo = meta ? ` (${meta.max_leverage}x)` : '';
            return `<option value="${p}/USD">${p}/USD${levInfo}</option>`;
        }).join('');
        
        // Try to restore selection, or default to first
        if (activePairs.map(p => `${p}/USD`).includes(currentVal)) {
            select.value = currentVal;
        } else if (activePairs.length > 0) {
            select.value = `${activePairs[0]}/USD`;
            // Trigger change to update UI
            const event = new Event('change');
            select.dispatchEvent(event);
        }
    }

    async function openPairManager() {
        const modal = document.getElementById('pair-manager-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('show'), 10);
        
        if (allPairsData.length === 0) {
            await refreshPairData();
        } else {
            renderPairTable();
        }
    }

    function closePairManager(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('pair-manager-modal');
        modal.classList.remove('show');
        setTimeout(() => modal.classList.add('hidden'), 300);
        updatePairDropdown(); // Refresh dropdown on close
    }

    async function refreshPairData() {
        const container = document.getElementById('pair-table-body');
        container.innerHTML = '<div class="text-center py-8 opacity-50"><i class="fas fa-circle-notch spin"></i> Fetching market data...</div>';
        
        const data = await fetchPairsData();
        if (data.length > 0) {
            renderPairTable();
        } else {
             container.innerHTML = `<div class="text-center py-8 text-red-400">Failed to load pairs data.</div>`;
        }
    }

    function sortPairs(field) {
        if (currentSort.field === field) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.field = field;
            currentSort.dir = 'desc'; // Default desc for numbers
            if (field === 'name') currentSort.dir = 'asc';
        }
        renderPairTable();
    }

    function filterPairTable() {
        renderPairTable();
    }

    function renderPairTable() {
        const search = document.getElementById('pair-search').value.toLowerCase();
        const container = document.getElementById('pair-table-body');
        
        let filtered = allPairsData.filter(p => p.name.toLowerCase().includes(search));
        
        // Sort
        filtered.sort((a, b) => {
            let valA = a[currentSort.field === 'change' ? 'change_24h' : currentSort.field];
            let valB = b[currentSort.field === 'change' ? 'change_24h' : currentSort.field];
            
            if (currentSort.dir === 'asc') return valA > valB ? 1 : -1;
            return valA < valB ? 1 : -1;
        });

        document.getElementById('pair-count-label').textContent = `${activePairs.length} pairs selected`;

        container.innerHTML = filtered.map(p => {
            const isActive = activePairs.includes(p.name);
            const changeColor = p.change_24h >= 0 ? 'text-green-400' : 'text-red-400';
            const volStr = p.volume > 1000000 ? `$${(p.volume/1000000).toFixed(1)}M` : `$${(p.volume/1000).toFixed(0)}K`;
            
            return `
            <div class="grid grid-cols-12 gap-2 px-2 py-2 items-center hover:bg-white/5 rounded border border-transparent hover:border-white/5 transition-colors">
                <div class="col-span-3 font-bold flex flex-col">
                    <span>${p.name}</span>
                    <span class="text-[9px] opacity-40 font-normal">Max ${p.max_leverage}x</span>
                </div>
                <div class="col-span-3 md:col-span-2 text-right font-mono text-xs truncate">$${formatPrice(p.price)}</div>
                <div class="col-span-3 md:col-span-2 text-right font-mono text-xs ${changeColor}">${p.change_24h > 0 ? '+' : ''}${p.change_24h.toFixed(2)}%</div>
                <div class="hidden md:block md:col-span-3 text-right font-mono text-xs opacity-70">${volStr}</div>
                <div class="col-span-3 md:col-span-2 text-center">
                    <button onclick="togglePair('${p.name}')" class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide transition-all ${isActive ? 'bg-red-500/20 text-red-300 hover:bg-red-500/30' : 'bg-green-500/20 text-green-300 hover:bg-green-500/30'}">
                        ${isActive ? 'Remove' : 'Add'}
                    </button>
                </div>
            </div>
            `;
        }).join('');
    }

    function togglePair(symbol) {
        if (activePairs.includes(symbol)) {
            activePairs = activePairs.filter(p => p !== symbol);
        } else {
            activePairs.push(symbol);
        }
        localStorage.setItem('MICROHYPER_ACTIVE_PAIRS', JSON.stringify(activePairs));
        renderPairTable();
    }

    // --- Counter Trade Logic ---
    function toggleCounterTrade() {
        counterTradeActive = !counterTradeActive;
        updateCounterTradeUI();
    }

    function updateCounterTradeUI() {
        const switchEl = document.getElementById('counter-trade-switch');
        const knob = document.getElementById('counter-trade-knob');
        const label = document.getElementById('counter-trade-label');
        
        if (counterTradeActive) {
            switchEl.classList.remove('bg-white/10', 'border-white/10');
            switchEl.classList.add('bg-amber-500/20', 'border-amber-500/50');
            
            knob.classList.add('translate-x-3');
            knob.classList.remove('bg-white/40');
            knob.classList.add('bg-amber-400');
            
            label.textContent = "Counter";
            label.classList.remove('opacity-40');
            label.classList.add('text-amber-400', 'opacity-100');
        } else {
            switchEl.classList.add('bg-white/10', 'border-white/10');
            switchEl.classList.remove('bg-amber-500/20', 'border-amber-500/50');
            
            knob.classList.remove('translate-x-3');
            knob.classList.add('bg-white/40');
            knob.classList.remove('bg-amber-400');
            
            label.textContent = "Norm";
            label.classList.add('opacity-40');
            label.classList.remove('text-amber-400', 'opacity-100');
        }
    }

    // --- Tab Logic ---
    function switchTab(tab) {
        currentTab = tab;
        
        const btnTrades = document.getElementById('tab-btn-trades');
        const btnAi = document.getElementById('tab-btn-ai-logs');
        const btnBots = document.getElementById('tab-btn-running-bots');
        const btnPos = document.getElementById('tab-btn-positions');
        
        const contentTrades = document.getElementById('tab-content-trades');
        const contentAi = document.getElementById('tab-content-ai-logs');
        const contentBots = document.getElementById('tab-content-running-bots');
        const contentPos = document.getElementById('tab-content-positions');
        
        // Reset all
        [btnTrades, btnAi, btnBots, btnPos].forEach(btn => {
             if(btn) btn.className = "pb-2 border-b-2 border-transparent text-white/50 hover:text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap";
        });
        [contentTrades, contentAi, contentBots, contentPos].forEach(c => {
             if(c) c.classList.add('hidden');
        });

        // Activate selected
        if (tab === 'trades') {
            btnTrades.className = "pb-2 border-b-2 border-violet-500 text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap";
            contentTrades.classList.remove('hidden');
            fetchHistory();
        } else if (tab === 'ai-logs') {
            btnAi.className = "pb-2 border-b-2 border-violet-500 text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap";
            contentAi.classList.remove('hidden');
            fetchAiLogs();
        } else if (tab === 'running-bots') {
            btnBots.className = "pb-2 border-b-2 border-violet-500 text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap";
            contentBots.classList.remove('hidden');
            fetchRunningBots();
        } else if (tab === 'positions') {
            btnPos.className = "pb-2 border-b-2 border-violet-500 text-white font-bold flex items-center gap-2 transition-all whitespace-nowrap";
            contentPos.classList.remove('hidden');
            fetchOpenPositions();
        }
    }

    async function fetchRunningBots() {
        try {
            const res = await axios.get(`${getApiBase()}/bot/list`);
            renderRunningBots(res.data);
        } catch (err) {
            console.error("Failed to fetch bots:", err);
        }
    }

    function renderRunningBots(bots) {
        const container = document.getElementById('running-bots-container');
        const statsContainer = document.getElementById('running-bots-stats');
        
        if (!bots || bots.length === 0) {
            container.innerHTML = '<div class="glass rounded-xl p-6 text-center opacity-50 col-span-full">No bots initialized.</div>';
            statsContainer.innerHTML = '';
            return;
        }
        
        const runningBots = bots.filter(b => b.running);
        
        // --- Calculate Stats ---
        const totalRunning = runningBots.length;
        let closedPnl = 0;
        let openPnl = 0;
        let totalLongs = 0;
        let totalShorts = 0;

        runningBots.forEach(b => {
            closedPnl += (b.stats?.pnl || 0);
            if (b.position) {
                openPnl += (b.position.unrealized_pnl || 0);
            }
            totalLongs += (b.stats?.longs || 0);
            totalShorts += (b.stats?.shorts || 0);
        });

        const totalProfit = closedPnl + openPnl;

        statsContainer.innerHTML = `
            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-wider opacity-50">Active</span>
                <span class="font-mono font-bold text-sm text-white">${totalRunning}</span>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-wider opacity-50">Closed</span>
                <span class="font-mono font-bold text-sm ${closedPnl >= 0 ? 'text-green-400' : 'text-red-400'}">${closedPnl >= 0 ? '+' : ''}$${formatPrice(closedPnl.toFixed(2))}</span>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-wider opacity-50">Open</span>
                <span class="font-mono font-bold text-sm ${openPnl >= 0 ? 'text-green-400' : 'text-red-400'}">${openPnl >= 0 ? '+' : ''}$${formatPrice(openPnl.toFixed(2))}</span>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-wider opacity-50">Net Profit</span>
                <span class="font-mono font-bold text-sm ${totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">${totalProfit >= 0 ? '+' : ''}$${formatPrice(totalProfit.toFixed(2))}</span>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex flex-col items-center">
                <span class="text-[9px] uppercase tracking-wider opacity-50">L/S</span>
                <span class="font-mono font-bold text-sm"><span class="text-green-400">${totalLongs}</span>/<span class="text-red-400">${totalShorts}</span></span>
            </div>
        `;

        if (runningBots.length === 0) {
             container.innerHTML = '<div class="glass rounded-xl p-6 text-center opacity-50 col-span-full">No active bots running.</div>';
             return;
        }

        container.innerHTML = runningBots.map(bot => {
            let statusColor = "text-green-400";
            let statusBg = "bg-green-500/10 border-green-500/20";
            let icon = "fa-robot";
            
            if (bot.status_text.includes("Cooldown")) {
                statusColor = "text-amber-400";
                statusBg = "bg-amber-500/10 border-amber-500/20";
                icon = "fa-hourglass-half";
            } else if (bot.status_text.includes("Position")) {
                statusColor = "text-blue-400";
                statusBg = "bg-blue-500/10 border-blue-500/20";
                icon = "fa-eye";
            }

            const isCounter = bot.counter_trade === true;
            const counterBadge = isCounter 
                ? `<span class="ml-2 text-[8px] font-bold text-amber-400 bg-amber-400/10 px-1.5 py-px rounded border border-amber-400/20 tracking-wider">COUNTER</span>` 
                : ``;

            // TP Display
            const tpDisplay = bot.take_profit 
                ? `<div class="flex justify-between items-center"><span class="opacity-50 text-[10px] uppercase">TP</span><span class="font-mono text-blue-300">$${formatPrice(bot.take_profit)}</span></div>` 
                : '';

            let contentHtml = '';
            
            if (bot.position) {
                const pos = bot.position;
                const isLong = pos.size > 0;
                const direction = isLong ? "LONG" : "SHORT";
                const dirColor = isLong ? "text-green-400" : "text-red-400";
                const pnlColor = pos.unrealized_pnl >= 0 ? "text-green-400" : "text-red-400";
                const roi = pos.roi.toFixed(2) + "%";
                const pnl = (pos.unrealized_pnl >= 0 ? "+" : "") + "$" + formatPrice(pos.unrealized_pnl);
                
                contentHtml = `
                    <div class="mt-3 pt-3 border-t border-white/5 grid grid-cols-2 gap-y-2 gap-x-4 text-xs">
                        <div class="flex justify-between items-center">
                            <span class="opacity-50 text-[10px] uppercase">Dir/Lev</span>
                            <span class="font-bold ${dirColor}">${direction} ${bot.leverage}x</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="opacity-50 text-[10px] uppercase">ROI</span>
                            <span class="font-mono">${roi}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="opacity-50 text-[10px] uppercase">Entry</span>
                            <span class="font-mono">$${formatPrice(pos.entry_price)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="opacity-50 text-[10px] uppercase">Liq</span>
                            <span class="font-mono text-orange-400">$${formatPrice(pos.liquidation_price)}</span>
                        </div>
                        ${tpDisplay}
                        <div class="flex justify-between items-center">
                            <span class="opacity-50 text-[10px] uppercase">Margin</span>
                            <span class="font-mono">$${formatPrice(pos.margin_used)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="opacity-50 text-[10px] uppercase">PnL</span>
                            <span class="font-mono font-bold ${pnlColor}">${pnl}</span>
                        </div>
                    </div>
                `;
            } else {
                contentHtml = `
                    <div class="grid grid-cols-2 gap-2 text-xs mt-2">
                        <div class="bg-white/5 rounded p-2 border border-white/5">
                            <div class="opacity-40 text-[10px] uppercase tracking-wide">Leverage</div>
                            <div class="font-mono font-bold">${bot.leverage}x</div>
                        </div>
                        <div class="bg-white/5 rounded p-2 border border-white/5">
                            <div class="opacity-40 text-[10px] uppercase tracking-wide">Size</div>
                            <div class="font-mono font-bold">$${bot.trade_size_usd}</div>
                        </div>
                        ${bot.take_profit ? `
                        <div class="bg-white/5 rounded p-2 border border-white/5">
                            <div class="opacity-40 text-[10px] uppercase tracking-wide">TP</div>
                            <div class="font-mono font-bold text-blue-300">$${formatPrice(bot.take_profit)}</div>
                        </div>` : ''}
                    </div>
                `;
            }

            // Stats Footer
            const statsHtml = `
                <div class="mt-3 pt-2 border-t border-white/5 flex justify-between items-center text-[9px] opacity-60 uppercase tracking-wide">
                    <div class="flex gap-2">
                        <span>Run: <b class="text-white">${formatDuration(bot.runtime)}</b></span>
                        ${bot.position ? `<span>Hold: <b class="text-white">${formatDuration(bot.holding_time)}</b></span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <span title="Total Longs">L: <b class="text-white">${bot.stats.longs}</b></span>
                        <span title="Total Shorts">S: <b class="text-white">${bot.stats.shorts}</b></span>
                        <span title="Realized PnL">PnL: <b class="${bot.stats.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${bot.stats.pnl >= 0 ? '+' : ''}$${formatPrice(bot.stats.pnl)}</b></span>
                    </div>
                </div>
            `;

            return `
            <div class="glass rounded-xl p-4 border ${statusBg} relative overflow-hidden group transition-all cursor-pointer" onclick="selectPair('${bot.pair}')">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icon} ${statusColor}"></i>
                        </div>
                        <div class="min-w-0">
                            <div class="font-bold text-base truncate">${bot.pair}</div>
                            <div class="flex items-center mt-0.5">
                                <div class="text-[10px] opacity-60 uppercase tracking-wider truncate">${bot.persona_set.replace(/_/g, ' ')}</div>
                                ${counterBadge}
                            </div>
                        </div>
                    </div>
                    <div class="px-2 py-1 rounded bg-black/20 border border-white/5 text-[10px] font-bold uppercase tracking-wide ${statusColor} whitespace-nowrap flex-shrink-0 ml-2">
                        ${bot.status_text}
                    </div>
                </div>
                
                ${contentHtml}
                ${statsHtml}
            </div>
            `;
        }).join('');
    }

    function selectPair(pair) {
        const select = document.getElementById('pair');
        select.value = pair;
        // Trigger change event manually
        const event = new Event('change');
        select.dispatchEvent(event);
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function fetchOpenPositions() {
        try {
            const res = await axios.get(`${getApiBase()}/positions`);
            lastFetchedPositions = res.data;
            renderOpenPositions();
        } catch (err) {
            console.error("Failed to fetch positions:", err);
            document.getElementById('open-positions-container').innerHTML = '<div class="p-6 text-center text-red-400">Failed to load positions</div>';
        }
    }

    function sortPositions(field) {
        if (currentPosSort.field === field) {
            currentPosSort.dir = currentPosSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            currentPosSort.field = field;
            currentPosSort.dir = 'desc';
        }
        renderOpenPositions();
    }

    function renderOpenPositions() {
        const container = document.getElementById('open-positions-container');
        const positions = lastFetchedPositions;
        
        if (!positions || positions.length === 0) {
            container.innerHTML = '<div class="glass rounded-xl p-6 text-center opacity-50">No open positions found.</div>';
            return;
        }

        // Sort
        positions.sort((a, b) => {
            let valA = a[currentPosSort.field];
            let valB = b[currentPosSort.field];
            
            // Handle absolute size for sorting
            if (currentPosSort.field === 'size') {
                valA = Math.abs(valA);
                valB = Math.abs(valB);
            }

            if (valA < valB) return currentPosSort.dir === 'asc' ? -1 : 1;
            if (valA > valB) return currentPosSort.dir === 'asc' ? 1 : -1;
            return 0;
        });

        const getSortIcon = (field) => {
            if (currentPosSort.field !== field) return '<i class="fas fa-sort text-white/20 ml-1"></i>';
            return currentPosSort.dir === 'asc' ? '<i class="fas fa-sort-up text-violet-400 ml-1"></i>' : '<i class="fas fa-sort-down text-violet-400 ml-1"></i>';
        };

        const html = `
        <!-- Mobile View (Cards) -->
        <div class="md:hidden space-y-3">
            ${positions.map(pos => {
                const isLong = pos.size > 0;
                const pnlColor = pos.unrealized_pnl >= 0 ? "text-green-400" : "text-red-400";
                const pnl = (pos.unrealized_pnl >= 0 ? "+" : "") + "$" + formatPrice(pos.unrealized_pnl);
                const roiColor = pos.roi >= 0 ? "text-green-400" : "text-red-400";
                const roi = (pos.roi >= 0 ? "+" : "") + pos.roi.toFixed(2) + "%";
                const openDate = pos.open_time > 0 ? new Date(pos.open_time) : null;
                const dateStr = openDate ? openDate.toLocaleString([], {month:'numeric', day:'numeric', hour: '2-digit', minute:'2-digit'}) : '-';
                const tpPrice = pos.tp_price ? `$${formatPrice(pos.tp_price)}` : '-';

                return `
                <div class="glass rounded-xl p-4 border-l-4 ${isLong ? 'border-green-500' : 'border-red-500'} hover:bg-white/5 transition-colors" onclick="selectPair('${pos.pair}')">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-white/5">
                        <div>
                            <div class="font-bold text-base flex items-center gap-2">
                                ${pos.pair}
                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-white/10 ${isLong ? 'text-green-400' : 'text-red-400'}">
                                    ${isLong ? 'LONG' : 'SHORT'} ${pos.leverage}x
                                </span>
                            </div>
                            <div class="text-xs opacity-50 mt-0.5">${dateStr}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs opacity-50 uppercase tracking-wide">PnL</div>
                            <div class="font-mono font-bold text-sm ${pnlColor}">${pnl}</div>
                            <div class="text-[10px] font-bold ${roiColor}">${roi}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-2 text-xs mt-3 pt-3 border-t border-white/5">
                        <div>
                            <div class="opacity-40">Entry</div>
                            <div class="font-mono">$${formatPrice(pos.entry_price)}</div>
                        </div>
                        <div class="text-center">
                            <div class="opacity-40">Margin</div>
                            <div class="font-mono">$${formatPrice(pos.margin_used)}</div>
                        </div>
                        <div class="text-center">
                            <div class="opacity-40">Liq</div>
                            <div class="font-mono text-orange-400">$${formatPrice(pos.liquidation_price)}</div>
                        </div>
                        <div class="text-right">
                            <div class="opacity-40">TP</div>
                            <div class="font-mono text-blue-300">${tpPrice}</div>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-3">
                        <button onclick="event.stopPropagation(); closePosition('${pos.pair}')" class="flex-1 py-2 rounded bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 text-xs font-bold">
                            Close
                        </button>
                        <button onclick="event.stopPropagation(); cancelOpenOrders('${pos.pair}')" class="flex-1 py-2 rounded bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 text-xs font-bold">
                            Cancel Orders
                        </button>
                    </div>
                </div>
                `;
            }).join('')}
        </div>

        <!-- Desktop View (Table) -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-[10px] font-bold uppercase tracking-wider opacity-50 border-b border-white/10 select-none">
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortPositions('pair')">Pair ${getSortIcon('pair')}</th>
                        <th class="p-3 cursor-pointer hover:text-white" onclick="sortPositions('open_time')">Open Time ${getSortIcon('open_time')}</th>
                        <th class="p-3 text-right cursor-pointer hover:text-white" onclick="sortPositions('entry_price')">Entry ${getSortIcon('entry_price')}</th>
                        <th class="p-3 text-right cursor-pointer hover:text-white" onclick="sortPositions('margin_used')">Margin ${getSortIcon('margin_used')}</th>
                        <th class="p-3 text-right cursor-pointer hover:text-white" onclick="sortPositions('roi')">% ROI ${getSortIcon('roi')}</th>
                        <th class="p-3 text-right cursor-pointer hover:text-white" onclick="sortPositions('liquidation_price')">Liq Price ${getSortIcon('liquidation_price')}</th>
                        <th class="p-3 text-right cursor-pointer hover:text-white" onclick="sortPositions('tp_price')">TP ${getSortIcon('tp_price')}</th>
                        <th class="p-3 text-right cursor-pointer hover:text-white" onclick="sortPositions('unrealized_pnl')">PnL ${getSortIcon('unrealized_pnl')}</th>
                        <th class="p-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-xs">
                    ${positions.map(pos => {
                        const isLong = pos.size > 0;
                        const pnlColor = pos.unrealized_pnl >= 0 ? "text-green-400" : "text-red-400";
                        const pnl = (pos.unrealized_pnl >= 0 ? "+" : "") + "$" + formatPrice(pos.unrealized_pnl);
                        const roiColor = pos.roi >= 0 ? "text-green-400" : "text-red-400";
                        const roi = (pos.roi >= 0 ? "+" : "") + pos.roi.toFixed(2) + "%";
                        const openDate = pos.open_time > 0 ? new Date(pos.open_time) : null;
                        const dateStr = openDate ? openDate.toLocaleString([], {month:'numeric', day:'numeric', hour: '2-digit', minute:'2-digit'}) : '-';
                        const tpPrice = pos.tp_price ? `$${formatPrice(pos.tp_price)}` : '<span class="opacity-30">-</span>';

                        return `
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors cursor-pointer" onclick="selectPair('${pos.pair}')">
                            <td class="p-3 font-bold">
                                <div class="flex items-center gap-2">
                                    <span class="${isLong ? 'text-green-400' : 'text-red-400'}">${pos.pair}</span>
                                    <span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-white/10 ${isLong ? 'text-green-400' : 'text-red-400'}">
                                        ${isLong ? 'LONG' : 'SHORT'} ${pos.leverage}x
                                    </span>
                                </div>
                            </td>
                            <td class="p-3 whitespace-nowrap">${dateStr}</td>
                            <td class="p-3 text-right font-mono">$${formatPrice(pos.entry_price)}</td>
                            <td class="p-3 text-right font-mono">$${formatPrice(pos.margin_used)}</td>
                            <td class="p-3 text-right font-mono font-bold ${roiColor}">${roi}</td>
                            <td class="p-3 text-right font-mono text-orange-400">$${formatPrice(pos.liquidation_price)}</td>
                            <td class="p-3 text-right font-mono text-blue-300">${tpPrice}</td>
                            <td class="p-3 text-right font-mono font-bold ${pnlColor}">${pnl}</td>
                            <td class="p-3 text-center" onclick="event.stopPropagation()">
                                <div class="flex items-center justify-center gap-2">
                                    <button onclick="closePosition('${pos.pair}')" class="p-1.5 rounded bg-red-500/20 hover:bg-red-500/40 text-red-400 transition-colors" title="Close Position">
                                        <i class="fas fa-door-open"></i>
                                    </button>
                                    <button onclick="cancelOpenOrders('${pos.pair}')" class="p-1.5 rounded bg-amber-500/20 hover:bg-amber-500/40 text-amber-400 transition-colors" title="Cancel Orders">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        `;
        
        container.innerHTML = html;
    }

    async function fetchAiLogs() {
        try {
            const res = await axios.get(`${getApiBase()}/ai_trades?limit=50`);
            lastFetchedAiLogs = res.data;
            renderAiLogs(lastFetchedAiLogs, currentAiLogFilter);
        } catch (err) {
            console.error("Failed to fetch AI logs:", err);
        }
    }

    function filterAiLogs(promptVal) {
        currentAiLogFilter = promptVal;
        renderAiLogs(lastFetchedAiLogs, currentAiLogFilter);
    }

    function renderAiLogs(logs, filterPrompt = 'All') {
        const container = document.getElementById('ai-logs-container');
        const filterSelect = document.getElementById('ai-log-filter');
        const longsCountEl = document.getElementById('ai-log-longs');
        const shortsCountEl = document.getElementById('ai-log-shorts');

        if (!logs || logs.length === 0) {
            container.innerHTML = '<div class="glass rounded-xl p-6 text-center opacity-50">No AI logs found.</div>';
            return;
        }

        // --- Populate Filter Dropdown (only if needed or just refresh it) ---
        // Get unique prompts
        const prompts = [...new Set(logs.map(l => (l.signal_output && l.signal_output.prompt_used) ? l.signal_output.prompt_used : 'Unknown'))].sort();
        
        // Save current selection if we are re-rendering
        const currentSelection = filterSelect.value === 'All' && filterPrompt !== 'All' ? filterPrompt : filterSelect.value;
        
        filterSelect.innerHTML = `<option value="All">All</option>` + prompts.map(p => `<option value="${p}">${p}</option>`).join('');
        filterSelect.value = filterPrompt;

        // --- Filter Logs ---
        let filteredLogs = logs;
        if (filterPrompt !== 'All') {
            filteredLogs = logs.filter(l => {
                const p = (l.signal_output && l.signal_output.prompt_used) ? l.signal_output.prompt_used : 'Unknown';
                return p === filterPrompt;
            });
        }

        // --- Count Stats ---
        let longCount = 0;
        let shortCount = 0;
        filteredLogs.forEach(l => {
            const signal = l.signal_output || {};
            const direction = l.direction || signal.signal || '';
            if (direction === 'LONG') longCount++;
            if (direction === 'SHORT') shortCount++;
        });
        
        longsCountEl.textContent = longCount;
        shortsCountEl.textContent = shortCount;

        // --- Render ---
        container.innerHTML = filteredLogs.map(log => {
            const date = new Date(log.timestamp);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const signal = log.signal_output || {};
            let trade_id = log.trade_id || 'N/A';
            if (trade_id.length >= 10) trade_id = 'Trade';
            
            const tradeIdColor = trade_id === 'Trade' ? 'text-green-400' : 'text-yellow-400';

            const direction = log.direction || signal.signal || 'N/A';
            const isLong = direction === 'LONG';
            const colorClass = isLong ? 'text-green-400' : (direction === 'SHORT' ? 'text-red-400' : 'text-white');
            const bgClass = isLong ? 'bg-green-500/10 border-green-500/20' : (direction === 'SHORT' ? 'bg-red-500/10 border-red-500/20' : 'bg-white/5 border-white/10');
            
            const confidence = signal.confidence || 'N/A';
            const rationale = signal.rationale_short || 'No rationale provided.';
            const strategy = signal.strategy !== undefined ? signal.strategy: 'None';
            const timeframe = signal.timeframe_bias || 'N/A';
            const tp_price = signal.take_profit !== undefined ? signal.take_profit : 'N/A';
            const described_personals = signal.described_personals || 'No persona description provided.';
            const prompt_used = signal.prompt_used || 'N/A';
            return `
            <div class="glass rounded-xl p-4 border ${bgClass} hover:bg-white/5 transition-colors">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-sm ${colorClass} px-2 py-0.5 rounded bg-black/30 border border-white/5">${direction}</span>
                        <span class="text-xs opacity-60 font-mono">${log.pair}</span>
                    </div>
                    <span class="text-[10px] opacity-40">${dateStr}</span>
                </div>
                
                <div class="mb-3">
                    <p class="text-xs opacity-90 leading-relaxed italic">"${rationale}"</p>
                    <p class="text-xs opacity-90 leading-relaxed">Personal: ${described_personals|| 'No persona description provided.'}</p>
                    <p class="text-xs opacity-90 leading-relaxed">Strategy: ${strategy|| 'No strategy provided.'}</p>
                </div>
                
                <div class="flex flex-wrap gap-2 text-[10px] uppercase tracking-wide opacity-70">
                    <div class="px-2 py-1 rounded bg-black/20 border border-white/5">
                        AI Action: <span class="font-bold ${tradeIdColor}">${trade_id}</span>
                    </div>
                    <div class="px-2 py-1 rounded bg-black/20 border border-white/5">
                        Conf: <span class="font-bold text-white">${confidence}</span>
                    </div>
                    <div class="px-2 py-1 rounded bg-black/20 border border-white/5">
                        TF: <span class="font-bold text-white">${timeframe}</span>
                    </div>
                    <div class="px-2 py-1 rounded bg-black/20 border border-white/5">
                        TP: <span class="font-bold text-white">${tp_price}</span>
                    </div>  
                    <div class="px-2 py-1 rounded bg-black/20 border border-white/5">
                        Prompt: <span class="font-bold text-white">${prompt_used}</span>
                    </div>                  
                </div>
            </div>
            `;
        }).join('');
    }

    function updateHistoryRange(val) {
      currentHistoryRange = parseInt(val);
      document.getElementById('history-range-label').textContent = val + 'h';
      if (lastFetchedTrades) {
        renderHistory(lastFetchedTrades);
      }
    }

    function formatPrice(num) {
      if (num === null || num === undefined || isNaN(num)) return 'N/A';
      const val = parseFloat(num);
      if (val === 0) return '0.00';
      const absVal = Math.abs(val);
      if (absVal < 0.00001) return val.toExponential(4);
      if (absVal < 1) return val.toFixed(6).replace(/\.?0+$/, "");
      if (absVal < 10) return val.toFixed(4).replace(/\.?0+$/, "");
      return val.toFixed(2);
    }

    function formatDuration(ms) {
      if (!ms || ms < 0) return "0m";
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days}day ${hours % 24}hr`;
      if (hours > 0) return `${hours}hr ${minutes % 60}min`;
      return `${minutes}min`;
    }

    function setLoading(isLoading, btnId = null) {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => {
        if (isLoading) {
          btn.disabled = true;
          btn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });

      if (btnId) {
        const btn = document.getElementById(btnId);
        if (isLoading) {
          const originalContent = btn.innerHTML;
          btn.setAttribute('data-original-content', originalContent);
          btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
        } else {
          const originalContent = btn.getAttribute('data-original-content');
          if (originalContent) btn.innerHTML = originalContent;
        }
      }
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toast-message");
      
      toastMessage.textContent = message;
      toast.className = `fixed bottom-5 right-5 z-50 text-white py-2 px-4 rounded-lg shadow-lg`; // Reset classes
      if (isError) {
        toast.classList.add('bg-red-600');
      } else {
        toast.classList.add('bg-green-600');
      }
      
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('show');
      }, 10); // Small delay to trigger transition

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 500);
      }, 3000);
    }

    async function executeTrade(direction, counter = false) {
      // Fallback to currently selectedDirection if direction not provided
      const finalDirection = direction || selectedDirection;
      
      const btnId = finalDirection === 'LONG' ? 'btn-long' : 'btn-short';
      const btn = document.getElementById(btnId);
      const originalContent = btn ? btn.innerHTML : '';
      if(btn) btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      
      setLoading(true);
      
      const payload = {
        pair: document.getElementById("pair").value,
        direction: finalDirection,
        leverage: parseFloat(document.getElementById("leverage").value),
        trade_size_usd: parseFloat(document.getElementById("size_usd").value) * parseFloat(document.getElementById("leverage").value),
        profit_take: document.getElementById("tp_price").value ? parseFloat(document.getElementById("tp_price").value) : null,
        follow_signal: !counter
      };
      try {
        const res = await axios.post(`${getApiBase()}/trade`, payload);
        if (res.data.status === 'filled') {
          showToast(`Trade executed successfully! Size: ${res.data.detail.size}`);
        } else {
          showToast(`Trade status: ${res.data.status}. ${res.data.detail?.detail || ''}`, true);
        }
        fetchStatus();
        fetchHistory();
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        const isCors = err.code === "ERR_NETWORK" && !err.response;
        if (isCors) {
            console.warn("CORS Error detected. If using Cloudflare Access, ensure CORS is configured in Zero Trust Dashboard > Access > Applications > Settings > CORS Settings.");
            showToast("Network Error (CORS? Check Console)", true);
        } else {
            showToast(`Trade failed: ${errorMessage}`, true);
        }
      } finally {
        setLoading(false);
        if(btn) btn.innerHTML = originalContent;
      }
    }

    async function executeAITrade() {
      const btn = document.getElementById('btn-ai');
      const originalContent = btn.innerHTML;
      btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      setLoading(true);

      const pair = document.getElementById("pair").value;
      const currentPersona = personaPreferences[pair] || "concise";

      const payload = {
        pair: pair,
        leverage: parseFloat(document.getElementById("leverage").value),
        trade_size_usd: parseFloat(document.getElementById("size_usd").value) * parseFloat(document.getElementById("leverage").value),
        persona_set: currentPersona,
        counter_trade: counterTradeActive // Send counter trade flag
      };
      
      showToast(`AI Analyzing market... ${counterTradeActive ? '(Counter Mode)' : ''}`, false);
      
      try {
        const res = await axios.post(`${getApiBase()}/trade/ai`, payload);
        if (res.data.status === 'filled') {
          const direction = res.data.signal.signal;
          showToast(`AI Executed ${direction}! Size: ${res.data.detail.size}`);
        } else if (res.data.status === 'skipped') {
           showToast(`AI decided to wait: ${res.data.reason}`, true);
        } else {
          showToast(`Trade status: ${res.data.status}. ${res.data.detail?.detail || ''}`, true);
        }
        fetchStatus();
        fetchHistory();
        fetchAiLogs(); // Refresh AI logs
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        const isCors = err.code === "ERR_NETWORK" && !err.response;
        if (isCors) {
            console.warn("CORS Error detected. If using Cloudflare Access, ensure CORS is configured in Zero Trust Dashboard.");
            showToast("Network Error (CORS? Check Console)", true);
        } else {
            showToast(`AI Trade failed: ${errorMessage}`, true);
        }
      } finally {
        setLoading(false);
        btn.innerHTML = originalContent;
      }
    }

    async function askAi() {
        const btn = document.getElementById('btn-ask-ai');
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
        setLoading(true);
        
        const modal = document.getElementById('ai-response-modal');
        const content = document.getElementById('ai-response-content');
        const tradeBtn = document.getElementById('btn-modal-trade');
        
        // Reset modal content
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 gap-4">
                <i class="fas fa-circle-notch spin text-3xl text-violet-400"></i>
                <p class="opacity-60 animate-pulse">Analyzing market structure...</p>
            </div>
        `;
        tradeBtn.classList.add('hidden');
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('show'), 10);

        const pair = document.getElementById("pair").value;
        const currentPersona = personaPreferences[pair] || "concise";

        try {
            const res = await axios.post(`${getApiBase()}/ask_ai`, { pair, persona_set: currentPersona });
            const aiData = res.data.ai_response;
            lastAiSignal = aiData; // Store for potential execution

            const direction = aiData.signal;
            const isLong = direction === 'LONG';
            const colorClass = isLong ? 'text-green-400' : (direction === 'SHORT' ? 'text-red-400' : 'text-white');
            
            content.innerHTML = `
                <div class="flex items-center justify-between border-b border-white/10 pb-4">
                    <div>
                        <div class="text-xs opacity-50 uppercase tracking-wide">Signal</div>
                        <div class="text-2xl font-bold ${colorClass}">${direction}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs opacity-50 uppercase tracking-wide">Confidence</div>
                        <div class="text-xl font-bold">${aiData.confidence}</div>
                    </div>
                </div>
                
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-xs opacity-50 uppercase tracking-wide mb-1">Rationale and Personals</div>
                    <p class="text-sm italic opacity-90 leading-relaxed">"${aiData.rationale || aiData.rationale_short}"</p>
                    <p class="text-sm italic opacity-90 leading-relaxed">"${aiData.described_personals}"</p>
                    <p class="text-sm italic opacity-90 leading-relaxed">Strategy: ${aiData.strategy !== undefined ? aiData.strategy: 'None'}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <div class="text-[10px] opacity-50 uppercase tracking-wide">Key Level</div>
                        <div class="font-mono font-bold">${aiData.key_level || 'N/A'}</div>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                        <div class="text-[10px] opacity-50 uppercase tracking-wide">Timeframe</div>
                        <div class="font-mono font-bold">${aiData.timeframe_bias || 'N/A'}</div>
                    </div>
                </div>
            `;
            
            // Show trade button if valid signal
            if (direction === 'LONG' || direction === 'SHORT') {
                tradeBtn.textContent = `Execute ${direction}`;
                tradeBtn.onclick = () => executeTradeFromModal(direction);
                tradeBtn.className = `flex-1 py-2 rounded-lg btn-primary font-bold text-white ${isLong ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`;
                tradeBtn.classList.remove('hidden');
            }

        } catch (err) {
            const errorMessage = err.response?.data?.detail || err.message;
            content.innerHTML = `
                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-200">Analysis Failed</p>
                    <p class="text-xs opacity-60 mt-1">${errorMessage}</p>
                </div>
            `;
        } finally {
            setLoading(false);
            btn.innerHTML = originalContent;
        }
    }

    function closeAiModal(event) {
        if (event && event.target !== event.currentTarget) return; // Only close if clicking backdrop or close button
        
        const modal = document.getElementById('ai-response-modal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 500);
    }

    function executeTradeFromModal(direction) {
        closeAiModal();
        // Small delay to allow modal close animation
        setTimeout(() => {
            executeTrade(direction);
        }, 300);
    }

    async function cancelOpenOrders(targetPair = null) {
      const btn = !targetPair ? document.getElementById('btn-cancel-orders') : null;
      const originalContent = btn ? btn.innerHTML : '';
      if(btn) {
          btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
          setLoading(true);
      }

      const pair = targetPair || document.getElementById("pair").value;
      try {
        const res = await axios.post(`${getApiBase()}/cancel_orders`, { pair });
        showToast(res.data.message || "Open orders cancelled");
        
        // Optimistic Update only if current pair
        if (!targetPair || targetPair === document.getElementById("pair").value) {
            document.getElementById('status-open-orders').innerHTML = `
            <div class="text-xs opacity-70 uppercase tracking-wide">Orders</div>
            <div class="text-xl md:text-2xl font-bold opacity-50">-</div>
            `;
            fetchStatus();
        }
        
        // Refresh positions tab if active
        if (currentTab === 'positions') fetchOpenPositions();

      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`Cancel orders failed: ${errorMessage}`, true);
      } finally {
        if(btn) {
            setLoading(false);
            btn.innerHTML = originalContent;
        }
      }
    }

    async function closePosition(targetPair = null) {
      const btn = !targetPair ? document.getElementById('btn-close-position') : null;
      const originalContent = btn ? btn.innerHTML : '';
      if(btn) {
          btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
          setLoading(true);
      }

      const pair = targetPair || document.getElementById("pair").value;
      try {
        const res = await axios.post(`${getApiBase()}/close_position`, { pair });
        showToast(res.data.message || "Position close submitted");
        
        // Optimistic Update only if current pair
        if (!targetPair || targetPair === document.getElementById("pair").value) {
            document.getElementById('status-open-position').innerHTML = `
            <div class="text-xs opacity-70 uppercase tracking-wide">Position</div>
            <div class="text-xl md:text-2xl font-bold opacity-50">Closing...</div>
            `;
            fetchStatus();
        }

        // Parallel fetch
        Promise.all([
            new Promise(resolve => setTimeout(async () => {
                if (!targetPair || targetPair === document.getElementById("pair").value) await fetchHistory();
                if (currentTab === 'positions') await fetchOpenPositions();
                resolve();
            }, 1000))
        ]);
        
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`Close position failed: ${errorMessage}`, true);
      } finally {
        if(btn) {
            setLoading(false);
            btn.innerHTML = originalContent;
        }
      }
    }

    async function updateTP() {
      const btn = document.getElementById('btn-update-tp');
      const originalContent = btn.innerHTML;
      btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      setLoading(true);

      const pair = document.getElementById("pair").value;
      const price = parseFloat(document.getElementById("tp_price").value);

      if (!price || isNaN(price)) {
        showToast("Please enter a valid TP price", true);
        setLoading(false);
        btn.innerHTML = originalContent;
        return;
      }

      try {
        const res = await axios.post(`${getApiBase()}/update_tp`, { pair, price });
        showToast("TP Updated Successfully");
        fetchStatus();
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`Update TP failed: ${errorMessage}`, true);
      } finally {
        setLoading(false);
        btn.innerHTML = originalContent;
      }
    }

    async function fetchHistory() {
      try {
        const pair = document.getElementById("pair").value;
        const res = await axios.get(`${getApiBase()}/history?pair=${pair}`);
        lastFetchedTrades = res.data;
        renderHistory(res.data);
      } catch (err) {
        console.error("Failed to fetch history:", err);
      }
    }

    function renderHistory(trades) {
      const container = document.getElementById('trade-history-container');
      const statsContainer = document.getElementById('history-stats');

      if (!trades || trades.length === 0) {
        container.innerHTML = '<div class="glass rounded-xl p-6 text-center opacity-50">No trade history found for this pair.</div>';
        if(statsContainer) statsContainer.innerHTML = '<span class="opacity-50 text-xs">No recent activity</span>';
        return;
      }

      // --- Calculate Stats based on dynamic range ---
      const now = new Date();
      const rangeMs = currentHistoryRange * 60 * 60 * 1000;
      const rangeStart = new Date(now - rangeMs);
      
      const recentTrades = trades.filter(t => new Date(t.time) > rangeStart);
      
      let pnlRange = 0;
      let feesRange = 0;
      let openLongCount = 0;
      let openShortsCount = 0;
      
      recentTrades.forEach(t => {
        pnlRange += t.pnl || 0;
        feesRange += t.fee || 0;
        const side = (t.side || '').toLowerCase();
        
        if (side.includes('open')) {
            if (side.includes('long') || side.includes('buy')) openLongCount++;
            if (side.includes('short') || side.includes('sell')) openShortsCount++;
        }
      });

      const netPnlRange = pnlRange - feesRange;
      const rangeLabel = `${currentHistoryRange}h`;

      if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 flex items-center gap-2" title="Realized PnL (${rangeLabel})">
                <span class="opacity-50 uppercase tracking-wider text-[10px]">${rangeLabel} PnL</span>
                <span class="font-mono font-bold ${pnlRange >= 0 ? 'text-green-400' : 'text-red-400'}">${pnlRange >= 0 ? '+' : ''}$${formatPrice(pnlRange)}</span>
            </div>
            <div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 flex items-center gap-2" title="Total Fees (${rangeLabel})">
                <span class="opacity-50 uppercase tracking-wider text-[10px]">Fees</span>
                <span class="font-mono font-bold text-orange-300">$${formatPrice(feesRange)}</span>
            </div>
            <div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 flex items-center gap-2" title="Net PnL after Fees (${rangeLabel})">
                <span class="opacity-50 uppercase tracking-wider text-[10px]">Net</span>
                <span class="font-mono font-bold ${netPnlRange >= 0 ? 'text-green-400' : 'text-red-400'}">${netPnlRange >= 0 ? '+' : ''}$${formatPrice(netPnlRange)}</span>
            </div>
            <div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 flex items-center gap-2" title="Longs Opened (${rangeLabel})">
                <span class="opacity-50 uppercase tracking-wider text-[10px]">Longs</span>
                <span class="font-mono font-bold text-green-400">${openLongCount}</span>
            </div>
            <div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 flex items-center gap-2" title="Shorts Opened (${rangeLabel})">
                <span class="opacity-50 uppercase tracking-wider text-[10px]">Shorts</span>
                <span class="font-mono font-bold text-red-400">${openShortsCount}</span>
            </div>
        `;
      }
      
      container.innerHTML = trades.map(t => {
        const isProfit = t.pnl > 0;
        const isLoss = t.pnl < 0;
        const pnlClass = isProfit ? 'text-green-400' : (isLoss ? 'text-red-400' : 'opacity-50');
        const pnlText = t.pnl !== 0 ? (t.pnl > 0 ? '+' : '') + `$${formatPrice(t.pnl)}` : '-';
        
        let sideColor = 'text-white';
        const sideLower = t.side.toLowerCase();
        if (sideLower.includes('long') || sideLower.includes('buy')) sideColor = 'text-green-400';
        if (sideLower.includes('short') || sideLower.includes('sell')) sideColor = 'text-red-400';

        const date = new Date(t.time);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        return `
        <div class="glass rounded-xl p-3 md:p-0 md:px-4 md:py-3 md:rounded-none md:bg-transparent md:border-0 md:border-b md:border-white/5 hover:bg-white/5 transition-colors">
            <!-- Mobile View (Card) -->
            <div class="md:hidden">
                <div class="flex justify-between items-center mb-2 pb-2 border-b border-white/5">
                    <span class="font-bold text-sm ${sideColor}">${t.side}</span>
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] opacity-40 uppercase tracking-wider">PnL</span>
                        <span class="font-mono font-bold text-xs ${pnlClass}">${pnlText}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-y-1 text-xs opacity-80">
                    <div class="col-span-2 flex justify-between"><span class="opacity-40">Time</span> <span>${dateStr}</span></div>
                    <div class="flex justify-between mr-2"><span class="opacity-40">Price</span> <span>$${formatPrice(t.price)}</span></div>
                    <div class="flex justify-between"><span class="opacity-40">Size</span> <span>${t.size.toFixed(2)}</span></div>
                    <div class="flex justify-between mr-2"><span class="opacity-40">Value</span> <span>$${formatPrice(t.value)}</span></div>
                    <div class="flex justify-between"><span class="opacity-40">Fee</span> <span>$${formatPrice(t.fee)}</span></div>
                </div>
            </div>

            <!-- Desktop View (Row) -->
            <div class="hidden md:grid grid-cols-8 gap-4 items-center text-xs">
                <div class="col-span-2 opacity-60">${dateStr}</div>
                <div class="col-span-1 font-bold ${sideColor}">${t.side}</div>
                <div class="col-span-1 text-right font-mono opacity-90">$${formatPrice(t.price)}</div>
                <div class="col-span-1 text-right font-mono opacity-90">${t.size.toFixed(2)}</div>
                <div class="col-span-1 text-right font-mono opacity-60">$${formatPrice(t.value)}</div>
                <div class="col-span-1 text-right font-mono opacity-60">$${formatPrice(t.fee)}</div>
                <div class="col-span-1 text-right font-mono font-bold ${pnlClass}">${pnlText}</div>
            </div>
        </div>
        `;
      }).join('');
    }

    function renderStatus(data) {
      const priceEl = document.getElementById('status-current-price');
      const marginEl = document.getElementById('status-available-margin');
      const positionEl = document.getElementById('status-open-position');
      const ordersEl = document.getElementById('status-open-orders');
      const pair = data.pair || (document.getElementById("pair")?.value?.split("/")[0] || "");
      
      // Update Market Changes
      const changesEl = document.getElementById('market-changes');
      if (changesEl && data.changes) {
          const fmt = (val) => {
              const v = parseFloat(val);
              const color = v >= 0 ? 'text-green-400' : 'text-red-400';
              const sign = v >= 0 ? '+' : '';
              return `<span class="${color}">${sign}${v.toFixed(2)}%</span>`;
          };
          
          changesEl.innerHTML = `
            <span title="3h Change">3h: ${fmt(data.changes.change_3h)}</span>
            <span title="6h Change">6h: ${fmt(data.changes.change_6h)}</span>
            <span title="12h Change">12h: ${fmt(data.changes.change_12h)}</span>
            <span title="24h Change">24h: ${fmt(data.changes.change_24h)}</span>
          `;
      }

      // Current Price
      const price = parseFloat(data.current_price);
      priceEl.innerHTML = `
        <div class="text-xs opacity-70 uppercase tracking-wide"> ${pair ? `${pair} Price` : "Price"}</div>
        <div class="text-xl md:text-2xl font-bold">${price ? `$${formatPrice(price)}` : 'N/A'}</div>
      `;

      // Available Margin
      const margin = parseFloat(data.available_margin);
      marginEl.innerHTML = `
        <div class="text-xs opacity-70 uppercase tracking-wide">Margin</div>
        <div class="text-xl md:text-2xl font-bold">${margin ? `$${formatPrice(margin)}` : '$0.00'}</div>
      `;

      // Open Position
      if (data.open_position) {
        const pos = data.open_position;
        const isLong = parseFloat(pos.szi) > 0;
        const pnl = parseFloat(pos.unrealizedPnl);
        const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
        positionEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Position</div>
          <div class="text-base md:text-lg font-bold ${isLong ? 'text-green-400' : 'text-red-400'} leading-tight">
            ${isLong ? 'LONG' : 'SHORT'} ${parseFloat(pos.szi).toFixed(2)}
          </div>
          <div class="text-[10px] md:text-xs opacity-80 mt-0.5">@$${formatPrice(pos.entryPx)} â€¢ <span class="${pnlColor}">$${formatPrice(pnl)}</span></div>
        `;
      } else {
        positionEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Position</div>
          <div class="text-xl md:text-2xl font-bold opacity-50">-</div>
        `;
      }

      // Open Orders
      if (data.open_orders && data.open_orders.length > 0) {
        const order = data.open_orders[0]; // Display first order
        const isBuy = order.side === 'B';
        let sideText = isBuy ? 'BUY' : 'SELL';
        if (order.reduceOnly) {
             sideText = isBuy ? 'Close Short' : 'Close Long';
        }
        // Shorten side text for mobile if needed
        if (sideText === 'Close Short') sideText = 'Cl. Short';
        if (sideText === 'Close Long') sideText = 'Cl. Long';

        ordersEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Order</div>
          <div class="text-base md:text-lg font-bold ${isBuy ? 'text-green-400' : 'text-red-400'} leading-tight">
            ${sideText} ${parseFloat(order.sz).toFixed(2)}
          </div>
           <div class="text-[10px] md:text-xs opacity-60 mt-0.5">@$${formatPrice(order.limitPx)}${data.open_orders.length > 1 ? ` (+${data.open_orders.length - 1})`: ''}</div>
        `;
      } else {
        ordersEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Orders</div>
          <div class="text-xl md:text-2xl font-bold opacity-50">-</div>
        `;
      }

      // Update Chart Overlay
      const overlayEl = document.getElementById('chart-overlay');
      const liqEl = document.getElementById('overlay-liq');
      const pnlEl = document.getElementById('overlay-pnl');

      if (data.open_position) {
        const pos = data.open_position;
        const liq = pos.liquidationPx ? parseFloat(pos.liquidationPx) : null;
        const pnl = parseFloat(pos.unrealizedPnl);
        
        if (overlayEl) overlayEl.classList.remove('hidden');
        if (liqEl) liqEl.textContent = liq ? `$${formatPrice(liq)}` : 'N/A';
        if (pnlEl) {
            pnlEl.textContent = (pnl >= 0 ? '+' : '') + `$${formatPrice(pnl)}`;
            pnlEl.className = `font-mono font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }
      } else {
        if (overlayEl) overlayEl.classList.add('hidden');
      }
    }

    async function fetchStatus() {
      try {
        const pair = document.getElementById("pair").value;
        const res = await axios.get(`${getApiBase()}/status?pair=${pair}`);
        renderStatus(res.data);
      } catch (err) {
        console.error("Failed to fetch status:", err);
        // Optionally show a toast for status fetch failure
      }
    }

    function setChartInterval(interval) {
      chartInterval = interval;
      // Update UI
      document.getElementById('btn-1m').className = `px-2 py-0.5 rounded text-[10px] transition-colors ${interval === '1m' ? 'bg-violet-500/50 text-white font-bold' : 'hover:bg-white/10'}`;
      document.getElementById('btn-3m').className = `px-2 py-0.5 rounded text-[10px] transition-colors ${interval === '3m' ? 'bg-violet-500/50 text-white font-bold' : 'hover:bg-white/10'}`;
      fetchMiniChart();
    }

    async function fetchMiniChart() {
      try {
        const pair = document.getElementById("pair").value;
        const symbol = pair.split("/")[0];
        // Request enough candles for ~2 hours history
        // 1m: 120 candles = 2 hours
        // 3m: 40 candles = 2 hours (but let's keep 60 for 3h history which is better context)
        const limit = chartInterval === '1m' ? 120 : 60;
        
        const res = await axios.get(`${getApiBase()}/ohlcv?symbol=${symbol}&interval=${chartInterval}&limit=${limit}`);
        const data = res.data || [];
        if (!Array.isArray(data) || data.length === 0) return;

        drawMiniChart(data, pair);
      } catch (err) {
        console.error("Failed to fetch mini chart:", err);
      }
    }

    function drawMiniChart(data, pair) {
      const canvas = document.getElementById("mini-chart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      
      // Handle high DPI
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = 180 * dpr;
      ctx.scale(dpr, dpr);

      const w = rect.width;
      const h = 180;

      ctx.clearRect(0, 0, w, h);

      // Margins
      const padTop = 10;
      const padBottom = 20;
      const padRight = 50; // Space for price labels
      const padLeft = 5;

      const chartW = w - padLeft - padRight;
      const chartH = h - padTop - padBottom;

      // Min/Max
      let minP = Infinity, maxP = -Infinity;
      data.forEach(d => {
        if (d.low < minP) minP = d.low;
        if (d.high > maxP) maxP = d.high;
      });
      const range = maxP - minP || 1;
      // Add padding to range
      minP -= range * 0.1;
      maxP += range * 0.1;
      const paddedRange = maxP - minP;

      const xFor = (i) => padLeft + (i * (chartW / data.length)) + ((chartW / data.length) / 2);
      const yFor = (p) => padTop + chartH - ((p - minP) / paddedRange) * chartH;

      // Draw Grid & Axes
      ctx.font = "10px sans-serif";
      
      // Y-Axis (Price) - 6 ticks
      const numYTicks = 6;
      for (let i = 0; i < numYTicks; i++) {
        const p = minP + (i * (paddedRange / (numYTicks - 1)));
        const y = yFor(p);
        
        // Grid line
        ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
        ctx.beginPath();
        ctx.moveTo(padLeft, y);
        ctx.lineTo(w - padRight, y);
        ctx.stroke();

        // Label
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        ctx.textAlign = "left";
        ctx.fillText(formatPrice(p), w - padRight + 5, y + 3);
      }

      // X-Axis (Time) - 6 ticks
      const numXTicks = 6;
      for (let i = 0; i < numXTicks; i++) {
        const idx = Math.floor((data.length -  1) * (i / (numXTicks - 1)));
        const d = data[idx];
        const x = xFor(idx);
        
        // Grid line
        ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
        ctx.beginPath();
        ctx.moveTo(x, padTop);
        ctx.lineTo(x, h - padBottom);
        ctx.stroke();

        // Label
        const date = new Date(d.time);
        const tStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        ctx.textAlign = "center";
        ctx.fillText(tStr, x, h - 5);
      }

      // Draw Candles
      const candleW = (chartW / data.length) * 0.6;

      data.forEach((d, i) => {
        const x = xFor(i);
        const yO = yFor(d.open);
        const yC = yFor(d.close);
        const yH = yFor(d.high);
        const yL = yFor(d.low);

        const isUp = d.close >= d.open;
        const color = isUp ? "#22c55e" : "#ef4444";

        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 1;

        // Wick
        ctx.beginPath();
        ctx.moveTo(x, yH);
        ctx.lineTo(x, yL);
        ctx.stroke();

        // Body
        const bodyH = Math.max(Math.abs(yC - yO), 1);
        const bodyY = Math.min(yO, yC);
        ctx.fillRect(x - candleW / 2, bodyY, candleW, bodyH);
      });

      // Current Price Line & Label
      const last = data[data.length - 1];
      const yLast = yFor(last.close);
      
      // Line
      ctx.strokeStyle = "rgba(251, 191, 36, 0.5)";
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(padLeft, yLast);
      ctx.lineTo(w - padRight, yLast);
      ctx.stroke();
      ctx.setLineDash([]);

      // Label Highlight
      ctx.fillStyle = "#fbbf24";
      ctx.textAlign = "left";
      ctx.fillText(formatPrice(last.close), w - padRight + 5, yLast + 3);

      // Update Header Label
      const labelEl = document.getElementById("mini-chart-label");
      if (labelEl) {
        const first = data[0].open;
        const current = last.close;
        const pct = ((current - first) / first) * 100;
        const colorClass = pct >= 0 ? "text-green-400" : "text-red-400";
        labelEl.innerHTML = `${pair} <span class="${colorClass}">${formatPrice(current)} (${pct >= 0 ? "+" : ""}${pct.toFixed(2)}%)</span>`;
      }
    }
    
    // Consolidated refresh function
    async function refreshDashboard() {
        const pair = document.getElementById("pair").value;
        if (!pair) return;

        // Parallelize requests
        const promises = [
            fetchStatus(),
            fetchBotStatus(),
            fetchMiniChart()
        ];

        // Conditional fetches based on active tab
        if (currentTab === 'trades') {
            promises.push(fetchHistory());
        } else if (currentTab === 'ai-logs') {
            promises.push(fetchAiLogs());
        } else if (currentTab === 'running-bots') {
            promises.push(fetchRunningBots());
        } else if (currentTab === 'positions') {
            promises.push(fetchOpenPositions());
        }

        await Promise.allSettled(promises);
    }

    // Debounced version for pair switching
    const debouncedRefresh = debounce(() => {
        refreshDashboard();
    }, 200); // Reduced to 200ms for snappier feel

    document.getElementById("pair").addEventListener("change", () => {
      // Clear charts/data immediately to indicate change
      document.getElementById("mini-chart-label").innerHTML = '<span class="opacity-50">Loading...</span>';
      
      // Immediate visual feedback for pair-specific cards using skeletons
      const loadingSkeleton = `
        <div class="animate-pulse flex flex-col justify-center h-full py-1">
            <div class="h-2 bg-white/10 rounded w-1/3 mb-2"></div>
            <div class="h-5 bg-white/10 rounded w-2/3"></div>
        </div>
      `;
      
      document.getElementById('status-current-price').innerHTML = loadingSkeleton;
      document.getElementById('status-open-position').innerHTML = loadingSkeleton;
      document.getElementById('status-open-orders').innerHTML = loadingSkeleton;
      
      // Note: We don't clear margin/account value as those are global
      
      debouncedRefresh();
    });

    // Live clock & status refresh
    // Use recursive setTimeout instead of setInterval to prevent queue buildup
    let pollingTimer = null;
    
    async function startPolling() {
        if (pollingTimer) clearTimeout(pollingTimer);
        
        const poll = async () => {
            document.getElementById("clock").textContent = new Date().toLocaleTimeString();
            if (getStoredKey()) {
                await refreshDashboard();
            }
            pollingTimer = setTimeout(poll, 5000);
        };
        
        poll();
    }
    
    // Initial load
    if (!getStoredKey()) {
        showApiKeyModal();
    } else {
        initPairs(); // Initialize pairs
        startPolling(); // Start polling loop
        fetchSettings(); // Fetch settings on load
    }

    // --- Bot Logic ---
    let isBotRunning = false;

    async function fetchBotStatus() {
        try {
            const pair = document.getElementById("pair").value;
            const res = await axios.get(`${getApiBase()}/bot/status?pair=${pair}`);
            const data = res.data;
            isBotRunning = data.running;
            
            // If bot is running, sync the persona preference with what's actually running
            if (data.running && data.persona_set) {
                personaPreferences[pair] = data.persona_set;
            }
            
            // Sync counter trade status if bot is running
            if (data.running) {
                if (counterTradeActive !== data.counter_trade) {
                    counterTradeActive = data.counter_trade;
                    updateCounterTradeUI();
                }
            }
            
            // Update badge based on preference or running state
            const currentPersona = personaPreferences[pair] || "concise";
            updatePersonaBadge(currentPersona);
            
            updateBotUI(data);
        } catch (err) {
            console.error("Failed to fetch bot status", err);
        }
    }

    function updateBotUI(data) {
        const btn = document.getElementById('btn-bot-toggle');
        const indicator = document.getElementById('bot-indicator');
        const statusText = document.getElementById('bot-status-text');
        
        if (data.running) {
            btn.className = "flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 transition-all group relative overflow-hidden";
            btn.innerHTML = `
                <i class="fas fa-stop text-red-400 text-sm group-hover:scale-110 transition-transform"></i>
                <span class="text-s font-bold opacity-90 text-red-300">Stop</span>
            `;
            
            indicator.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)] pulse flex-shrink-0 mt-0.5";
            
            let statusMsg = "Running";
            if (data.cooldown_active) {
                statusMsg = `Cooldown (${data.cooldown_remaining}s)`;
                indicator.className = "w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse flex-shrink-0 mt-0.5";
            } else if (data.position_open) {
                statusMsg = "Monitoring Position";
                indicator.className = "w-2.5 h-2.5 rounded-full bg-blue-500 flex-shrink-0 mt-0.5";
            }
            statusText.textContent = statusMsg;
        } else {
            btn.className = "flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 transition-all group relative overflow-hidden";
            btn.innerHTML = `
                <div class="absolute inset-0 bg-gradient-to-tr from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i class="fas fa-power-off text-green-400 text-sm group-hover:scale-110 transition-transform"></i>
                <span class="text-s font-bold opacity-90">Auto</span>
            `;
            
            indicator.className = "w-2.5 h-2.5 rounded-full bg-gray-500 flex-shrink-0 mt-0.5";
            statusText.textContent = "Stopped";
        }
    }

    async function toggleBot() {
        const btn = document.getElementById('btn-bot-toggle');
        // Don't store textContent as it destroys HTML structure
        btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
        btn.disabled = true;

        const pair = document.getElementById("pair").value;
        const action = isBotRunning ? "stop" : "start";
        const currentPersona = personaPreferences[pair] || "concise";
        
        const payload = {
            action: action,
            pair: pair,
            leverage: parseInt(document.getElementById("leverage").value),
           
            trade_size_usd: parseFloat(document.getElementById("size_usd").value) * parseFloat(document.getElementById("leverage").value),
            take_profit: document.getElementById("tp_price").value ? parseFloat(document.getElementById("tp_price").value) : null,
            persona_set: currentPersona,
            counter_trade: counterTradeActive // Send counter trade flag
          };

        try {
            const res = await axios.post(`${getApiBase()}/bot/configure`, payload);
            if (res.data.status === "started") {
                showToast(`Auto Bot Started (${currentPersona}${counterTradeActive ? ', Counter' : ''})`);
                isBotRunning = true;
            } else {
                showToast("Auto Bot Stopped");
                isBotRunning = false;
            }
            await fetchBotStatus(); // Wait for UI update
        } catch (err) {
            showToast("Failed to toggle bot", true);
            console.error(err);
            // If failed, we should probably fetch status to reset UI
            fetchBotStatus();
        } finally {
            btn.disabled = false;
            // Do NOT restore text content here, rely on fetchBotStatus/updateBotUI
        }
    }

    // --- Settings Logic ---
    // let currentPersonaSet = "detailed"; // Removed global tracking

    async function fetchSettings() {
        try {
            const pair = document.getElementById("pair").value;
            const res = await axios.get(`${getApiBase()}/settings/persona`);
            
            // Use local preference for current pair, fallback to 'concise'
            const currentForPair = personaPreferences[pair] || "concise";
            
            renderSettingsOptions(res.data.options, currentForPair);
            updatePersonaBadge(currentForPair);
        } catch (err) {
            console.error("Failed to fetch settings:", err);
        }
    }

    function updatePersonaBadge(name) {
        const badge = document.getElementById('persona-badge');
        if(badge) {
            const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            badge.textContent = "AI Theme: " + displayName;
            badge.classList.remove('opacity-0');
        }
    }

    function renderSettingsOptions(options, current) {
        const container = document.getElementById('persona-options-container');
        container.innerHTML = options.map(opt => {
            // Handle both string options (legacy) and object options (new)
            const id = typeof opt === 'string' ? opt : opt.id;
            const name = typeof opt === 'string' ? opt.charAt(0).toUpperCase() + opt.slice(1) : opt.name;
            const desc = typeof opt === 'string' ? '' : opt.description;
            
            const isSelected = id === current;
            
            return `
            <label class="flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all ${isSelected ? 'bg-violet-600/20 border-violet-500' : 'bg-white/5 border-white/10 hover:bg-white/10'}">
                <input type="radio" name="persona_set" value="${id}" ${isSelected ? 'checked' : ''} class="mt-1 accent-violet-500">
                <div>
                    <div class="font-bold text-sm ${isSelected ? 'text-violet-300' : 'text-white'}">${name}</div>
                    <div class="text-[10px] opacity-60">${desc}</div>
                </div>
                       </label>
            `;
        }).join('');
    }

    function openSettingsModal() {
        fetchSettings(); // Refresh before showing
        const modal = document.getElementById('settings-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeSettingsModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('settings-modal');
        modal.classList.remove('show');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function saveSettings() {
        const btn = document.getElementById('btn-save-settings');
        const originalText = btn.textContent;
        btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
        btn.disabled = true;

        const selected = document.querySelector('input[name="persona_set"]:checked').value;
        const pair = document.getElementById("pair").value;

        try {
            // Just update local preference. It will be sent when bot starts.
            personaPreferences[pair] = selected;
            
            // If bot is currently running, we might want to restart it or notify user.
            // For now, we just update the UI badge. The user must restart bot to apply changes if running.
            // Or we could auto-restart. Let's keep it simple: update UI.
            
            updatePersonaBadge(selected);
            showToast(`Theme set to ${selected} for ${pair}`);
            closeSettingsModal();
            
            // Optional: If bot is running, maybe flash a warning or auto-restart?
            if (isBotRunning) {
                 showToast("Restart bot to apply new theme", true);
            }
            
        } catch (err) {
            showToast("Failed to save settings", true);
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }
  </script>
</body>
</html>
