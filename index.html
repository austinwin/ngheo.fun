<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hyperliquid Sentinel — Trading Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
    .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.18); }
    .glow { box-shadow: 0 0 14px rgba(139, 92, 246, 0.35); }
    .btn-primary { transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.25); }
    .signal-long { background: linear-gradient(45deg, #22c55e, #16a34a); }
    .signal-short { background: linear-gradient(45deg, #ef4444, #dc2626); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #toast {
      transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
      transform: translateY(-100px);
      opacity: 0;
    }
    #toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body class="text-white text-sm md:text-base">
  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-5 right-5 z-50 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg hidden">
    <p id="toast-message"></p>
  </div>

  <div class="container mx-auto px-3 py-4 max-w-5xl">
    <!-- Status Dashboard -->
    <div id="status-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-center">
      <div id="status-current-price" class="glass rounded-lg p-3 md:p-4"></div>
      <div id="status-available-margin" class="glass rounded-lg p-3 md:p-4"></div>
      <div id="status-open-position" class="glass rounded-lg p-3 md:p-4"></div>
      <div id="status-open-orders" class="glass rounded-lg p-3 md:p-4"></div>
    </div>

    <div class="grid lg:grid-cols-2 gap-4">
      <!-- Manual Trade Panel -->
      <div class="lg:col-span-2">
        <div class="glass rounded-2xl p-4 md:p-6 glow">
          <div class="flex items-center justify-between mb-4 gap-4">
            <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
              <i class="fas fa-chart-line text-green-400"></i> Microloop
            </h2>
            <div class="flex gap-2 text-xs md:text-sm">
              <button id="btn-close-position" class="px-3 py-1.5 rounded-lg bg-red-600/80 hover:bg-red-700 flex items-center gap-1" onclick="closePosition()">
                <i class="fas fa-door-open"></i><span>Close Position</span>
              </button>
              <button id="btn-cancel-orders" class="px-3 py-1.5 rounded-lg bg-amber-500/80 hover:bg-amber-600 flex items-center gap-1" onclick="cancelOpenOrders()">
                <i class="fas fa-ban"></i><span>Cancel Orders</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-12 gap-2 mb-4 items-end">
            <!-- Pair -->
            <div class="col-span-12">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">Pair</label>
              <select id="pair" class="w-full px-2 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm">
                <option>SOL/USD</option>
                <option>BTC/USD</option>
                <option>ETH/USD</option>
                <option>HYPE/USD</option>
                <option>ZEC/USD</option>
                <option>PUMP/USD</option>
                <option>BCH/USD</option>
              </select>
            </div>

            <!-- Leverage -->
            <div class="col-span-3">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">Lev</label>
              <input type="number" id="leverage" value="20" min="1" max="50" class="w-full px-2 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm text-center"/>
            </div>

            <!-- Position Size USD -->
            <div class="col-span-4">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">Size ($)</label>
              <input type="number" step="1" id="size_usd" value="50" min="1" class="w-full px-2 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm"/>
            </div>

            <!-- Take Profit Price -->
            <div class="col-span-5">
              <label class="block text-[10px] font-bold uppercase tracking-wide mb-1 opacity-70">TP <span class="font-normal normal-case opacity-50">(Opt)</span></label>
              <input type="number" step="0.01" id="tp_price" placeholder="Price" class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/15 focus:border-violet-500 focus:outline-none text-sm"/>
            </div>
          </div>

          <!-- Mini Price Chart -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-1 text-xs opacity-75">
              <div class="flex items-center gap-2">
                <span class="flex items-center gap-1"><i class="fas fa-chart-bar text-violet-400"></i> Price Action</span>
                <div class="flex bg-white/10 rounded-lg p-0.5">
                  <button onclick="setChartInterval('1m')" id="btn-1m" class="px-2 py-0.5 rounded text-[10px] hover:bg-white/10 transition-colors">1m</button>
                  <button onclick="setChartInterval('3m')" id="btn-3m" class="px-2 py-0.5 rounded text-[10px] bg-violet-500/50 text-white font-bold">3m</button>
                </div>
              </div>
              <span id="mini-chart-label" class="text-[10px] uppercase tracking-wide"></span>
            </div>
            <div class="glass rounded-xl p-2">
              <canvas id="mini-chart" class="w-full" height="180"></canvas>
            </div>
          </div>

          <div class="flex gap-3">
            <button id="btn-long" onclick="executeTrade('LONG')" class="flex-1 py-3 btn-primary rounded-xl font-semibold text-base bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 flex items-center justify-center gap-2">
              <i class="fas fa-arrow-up"></i><span>Long</span>
            </button>
            <button id="btn-ai" onclick="executeAITrade()" class="flex-1 py-3 btn-primary rounded-xl font-semibold text-base bg-gradient-to-r from-violet-600 to-purple-700 hover:from-violet-700 hover:to-purple-800 flex items-center justify-center gap-2">
              <i class="fas fa-robot"></i><span>AI</span>
            </button>
            <button id="btn-short" onclick="executeTrade('SHORT')" class="flex-1 py-3 btn-primary rounded-xl font-semibold text-base bg-gradient-to-r from-red-600 to-rose-700 hover:from-red-700 hover:to-rose-800 flex items-center justify-center gap-2">
              <i class="fas fa-arrow-down"></i><span>Short</span>
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-6 opacity-60 text-xs md:text-sm">
      <p>Hyperliquid Sentinel Manual Dashboard • <span id="clock"></span></p>
      <!--
      To launch backend:
      uvicorn main:app --reload --port 8000
      To launch frontend:
      python3 -m http.server 8080
      Then open http://localhost:8080/index.html in your browser.
      -->
    </div>
  </div>

  <script>
    const API_BASE = "http://192.168.1.167:8000"; // Change to your deployed URL, or leave empty if same origin
    let selectedDirection = "LONG";
    let chartInterval = "3m"; // Default to 3m

    function setLoading(isLoading, btnId = null) {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => {
        if (isLoading) {
          btn.disabled = true;
          btn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });

      if (btnId) {
        const btn = document.getElementById(btnId);
        if (isLoading) {
          const originalContent = btn.innerHTML;
          btn.setAttribute('data-original-content', originalContent);
          btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
        } else {
          const originalContent = btn.getAttribute('data-original-content');
          if (originalContent) btn.innerHTML = originalContent;
        }
      }
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toast-message");
      
      toastMessage.textContent = message;
      toast.className = `fixed bottom-5 right-5 z-50 text-white py-2 px-4 rounded-lg shadow-lg`; // Reset classes
      if (isError) {
        toast.classList.add('bg-red-600');
      } else {
        toast.classList.add('bg-green-600');
      }
      
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('show');
      }, 10); // Small delay to trigger transition

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 500);
      }, 3000);
    }

    async function executeTrade(direction, counter = false) {
      // Fallback to currently selectedDirection if direction not provided
      const finalDirection = direction || selectedDirection;
      
      const btnId = finalDirection === 'LONG' ? 'btn-long' : 'btn-short';
      const btn = document.getElementById(btnId);
      const originalContent = btn ? btn.innerHTML : '';
      if(btn) btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      
      setLoading(true);
      
      const payload = {
        pair: document.getElementById("pair").value,
        direction: finalDirection,
        leverage: parseFloat(document.getElementById("leverage").value),
        trade_size_usd: parseFloat(document.getElementById("size_usd").value),
        profit_take: document.getElementById("tp_price").value ? parseFloat(document.getElementById("tp_price").value) : null,
        follow_signal: !counter
      };
      try {
        const res = await axios.post(`${API_BASE}/trade`, payload);
        if (res.data.status === 'filled') {
          showToast(`Trade executed successfully! Size: ${res.data.detail.size}`);
        } else {
          showToast(`Trade status: ${res.data.status}. ${res.data.detail?.detail || ''}`, true);
        }
        fetchStatus();
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`Trade failed: ${errorMessage}`, true);
      } finally {
        setLoading(false);
        if(btn) btn.innerHTML = originalContent;
      }
    }

    async function executeAITrade() {
      const btn = document.getElementById('btn-ai');
      const originalContent = btn.innerHTML;
      btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      setLoading(true);

      const payload = {
        pair: document.getElementById("pair").value,
        leverage: parseFloat(document.getElementById("leverage").value),
        trade_size_usd: parseFloat(document.getElementById("size_usd").value)
      };
      
      showToast("AI Analyzing market...", false);
      
      try {
        const res = await axios.post(`${API_BASE}/trade/ai`, payload);
        if (res.data.status === 'filled') {
          const direction = res.data.signal.signal;
          showToast(`AI Executed ${direction}! Size: ${res.data.detail.size}`);
        } else if (res.data.status === 'skipped') {
           showToast(`AI decided to wait: ${res.data.reason}`, true);
        } else {
          showToast(`Trade status: ${res.data.status}. ${res.data.detail?.detail || ''}`, true);
        }
        fetchStatus();
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`AI Trade failed: ${errorMessage}`, true);
      } finally {
        setLoading(false);
        btn.innerHTML = originalContent;
      }
    }

    async function cancelOpenOrders() {
      const btn = document.getElementById('btn-cancel-orders');
      const originalContent = btn.innerHTML;
      btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      setLoading(true);

      const pair = document.getElementById("pair").value;
      try {
        const res = await axios.post(`${API_BASE}/cancel_orders`, { pair });
        showToast(res.data.message || "Open orders cancelled");
        fetchStatus();
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`Cancel orders failed: ${errorMessage}`, true);
      } finally {
        setLoading(false);
        btn.innerHTML = originalContent;
      }
    }

    async function closePosition() {
      const btn = document.getElementById('btn-close-position');
      const originalContent = btn.innerHTML;
      btn.innerHTML = `<i class="fas fa-circle-notch spin"></i>`;
      setLoading(true);

      const pair = document.getElementById("pair").value;
      try {
        const res = await axios.post(`${API_BASE}/close_position`, { pair });
        showToast(res.data.message || "Position close submitted");
        fetchStatus();
      } catch (err) {
        const errorMessage = err.response?.data?.detail || err.message;
        showToast(`Close position failed: ${errorMessage}`, true);
      } finally {
        setLoading(false);
        btn.innerHTML = originalContent;
      }
    }

    function renderStatus(data) {
      const priceEl = document.getElementById('status-current-price');
      const marginEl = document.getElementById('status-available-margin');
      const positionEl = document.getElementById('status-open-position');
      const ordersEl = document.getElementById('status-open-orders');

      // Current Price
      const price = parseFloat(data.current_price);
      priceEl.innerHTML = `
        <div class="text-xs opacity-70 uppercase tracking-wide">Price</div>
        <div class="text-xl md:text-2xl font-bold">${price ? `$${price.toFixed(2)}` : 'N/A'}</div>
      `;

      // Available Margin
      const margin = parseFloat(data.available_margin);
      marginEl.innerHTML = `
        <div class="text-xs opacity-70 uppercase tracking-wide">Margin</div>
        <div class="text-xl md:text-2xl font-bold">${margin ? `$${margin.toFixed(2)}` : '$0.00'}</div>
      `;

      // Open Position
      if (data.open_position) {
        const pos = data.open_position;
        const isLong = parseFloat(pos.szi) > 0;
        const pnl = parseFloat(pos.unrealizedPnl);
        const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
        positionEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Position</div>
          <div class="text-base md:text-lg font-bold ${isLong ? 'text-green-400' : 'text-red-400'} leading-tight">
            ${isLong ? 'LONG' : 'SHORT'} ${parseFloat(pos.szi).toFixed(2)}
          </div>
          <div class="text-[10px] md:text-xs opacity-80 mt-0.5">@${parseFloat(pos.entryPx).toFixed(2)} • <span class="${pnlColor}">$${pnl.toFixed(2)}</span></div>
        `;
      } else {
        positionEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Position</div>
          <div class="text-xl md:text-2xl font-bold opacity-50">-</div>
        `;
      }

      // Open Orders
      if (data.open_orders && data.open_orders.length > 0) {
        const order = data.open_orders[0]; // Display first order
        const isBuy = order.side === 'B';
        let sideText = isBuy ? 'BUY' : 'SELL';
        if (order.reduceOnly) {
             sideText = isBuy ? 'Close Short' : 'Close Long';
        }
        // Shorten side text for mobile if needed
        if (sideText === 'Close Short') sideText = 'Cl. Short';
        if (sideText === 'Close Long') sideText = 'Cl. Long';

        ordersEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Order</div>
          <div class="text-base md:text-lg font-bold ${isBuy ? 'text-green-400' : 'text-red-400'} leading-tight">
            ${sideText} ${parseFloat(order.sz).toFixed(2)}
          </div>
           <div class="text-[10px] md:text-xs opacity-60 mt-0.5">@$${parseFloat(order.limitPx).toFixed(2)}${data.open_orders.length > 1 ? ` (+${data.open_orders.length - 1})`: ''}</div>
        `;
      } else {
        ordersEl.innerHTML = `
          <div class="text-xs opacity-70 uppercase tracking-wide">Orders</div>
          <div class="text-xl md:text-2xl font-bold opacity-50">-</div>
        `;
      }
    }

    async function fetchStatus() {
      try {
        const pair = document.getElementById("pair").value;
        const res = await axios.get(`${API_BASE}/status?pair=${pair}`);
        renderStatus(res.data);
      } catch (err) {
        console.error("Failed to fetch status:", err);
        // Optionally show a toast for status fetch failure
      }
    }

    function setChartInterval(interval) {
      chartInterval = interval;
      // Update UI
      document.getElementById('btn-1m').className = `px-2 py-0.5 rounded text-[10px] transition-colors ${interval === '1m' ? 'bg-violet-500/50 text-white font-bold' : 'hover:bg-white/10'}`;
      document.getElementById('btn-3m').className = `px-2 py-0.5 rounded text-[10px] transition-colors ${interval === '3m' ? 'bg-violet-500/50 text-white font-bold' : 'hover:bg-white/10'}`;
      fetchMiniChart();
    }

    async function fetchMiniChart() {
      try {
        const pair = document.getElementById("pair").value;
        const symbol = pair.split("/")[0];
        // Request enough candles for ~2 hours history
        // 1m: 120 candles = 2 hours
        // 3m: 40 candles = 2 hours (but let's keep 60 for 3h history which is better context)
        const limit = chartInterval === '1m' ? 120 : 60;
        
        const res = await axios.get(`${API_BASE}/ohlcv?symbol=${symbol}&interval=${chartInterval}&limit=${limit}`);
        const data = res.data || [];
        if (!Array.isArray(data) || data.length === 0) return;

        drawMiniChart(data, pair);
      } catch (err) {
        console.error("Failed to fetch mini chart:", err);
      }
    }

    function drawMiniChart(data, pair) {
      const canvas = document.getElementById("mini-chart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      
      // Handle high DPI
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = 180 * dpr;
      ctx.scale(dpr, dpr);

      const w = rect.width;
      const h = 180;

      ctx.clearRect(0, 0, w, h);

      // Margins
      const padTop = 10;
      const padBottom = 20;
      const padRight = 50; // Space for price labels
      const padLeft = 5;

      const chartW = w - padLeft - padRight;
      const chartH = h - padTop - padBottom;

      // Min/Max
      let minP = Infinity, maxP = -Infinity;
      data.forEach(d => {
        if (d.low < minP) minP = d.low;
        if (d.high > maxP) maxP = d.high;
      });
      const range = maxP - minP || 1;
      // Add padding to range
      minP -= range * 0.1;
      maxP += range * 0.1;
      const paddedRange = maxP - minP;

      const xFor = (i) => padLeft + (i * (chartW / data.length)) + ((chartW / data.length) / 2);
      const yFor = (p) => padTop + chartH - ((p - minP) / paddedRange) * chartH;

      // Draw Grid & Axes
      ctx.font = "10px sans-serif";
      
      // Y-Axis (Price) - 6 ticks
      const numYTicks = 6;
      for (let i = 0; i < numYTicks; i++) {
        const p = minP + (i * (paddedRange / (numYTicks - 1)));
        const y = yFor(p);
        
        // Grid line
        ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
        ctx.beginPath();
        ctx.moveTo(padLeft, y);
        ctx.lineTo(w - padRight, y);
        ctx.stroke();

        // Label
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        ctx.textAlign = "left";
        ctx.fillText(p.toFixed(2), w - padRight + 5, y + 3);
      }

      // X-Axis (Time) - 6 ticks
      const numXTicks = 6;
      for (let i = 0; i < numXTicks; i++) {
        const idx = Math.floor((data.length - 1) * (i / (numXTicks - 1)));
        const d = data[idx];
        const x = xFor(idx);
        
        // Grid line
        ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
        ctx.beginPath();
        ctx.moveTo(x, padTop);
        ctx.lineTo(x, h - padBottom);
        ctx.stroke();

        // Label
        const date = new Date(d.time);
        const tStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        ctx.textAlign = "center";
        ctx.fillText(tStr, x, h - 5);
      }

      // Draw Candles
      const candleW = (chartW / data.length) * 0.6;

      data.forEach((d, i) => {
        const x = xFor(i);
        const yO = yFor(d.open);
        const yC = yFor(d.close);
        const yH = yFor(d.high);
        const yL = yFor(d.low);

        const isUp = d.close >= d.open;
        const color = isUp ? "#22c55e" : "#ef4444";

        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 1;

        // Wick
        ctx.beginPath();
        ctx.moveTo(x, yH);
        ctx.lineTo(x, yL);
        ctx.stroke();

        // Body
        const bodyH = Math.max(Math.abs(yC - yO), 1);
        const bodyY = Math.min(yO, yC);
        ctx.fillRect(x - candleW / 2, bodyY, candleW, bodyH);
      });

      // Current Price Line & Label
      const last = data[data.length - 1];
      const yLast = yFor(last.close);
      
      // Line
      ctx.strokeStyle = "rgba(251, 191, 36, 0.5)";
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(padLeft, yLast);
      ctx.lineTo(w - padRight, yLast);
      ctx.stroke();
      ctx.setLineDash([]);

      // Label Highlight
      ctx.fillStyle = "#fbbf24";
      ctx.textAlign = "left";
      ctx.fillText(last.close.toFixed(2), w - padRight + 5, yLast + 3);

      // Update Header Label
      const labelEl = document.getElementById("mini-chart-label");
      if (labelEl) {
        const first = data[0].open;
        const current = last.close;
        const pct = ((current - first) / first) * 100;
        const colorClass = pct >= 0 ? "text-green-400" : "text-red-400";
        labelEl.innerHTML = `${pair} <span class="${colorClass}">${current.toFixed(2)} (${pct >= 0 ? "+" : ""}${pct.toFixed(2)}%)</span>`;
      }
    }
    
    document.getElementById("pair").addEventListener("change", () => {
      fetchStatus();
      fetchMiniChart();
    });

    // Live clock & status refresh
    setInterval(() => {
      document.getElementById("clock").textContent = new Date().toLocaleTimeString();
      fetchStatus();
      fetchMiniChart();
    }, 5000); // Refresh every 5 seconds
    
    // Initial load
    fetchStatus();
    fetchMiniChart();
  </script>
</body>
</html>
